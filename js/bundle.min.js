embedit={};embedit.imageTypes={image:"image",gfycat:"gfycat",gifv:"gifv",redgif:"redgif"};embedit.redditBaseUrl="http://old.reddit.com";if(typeof window==="undefined"){var window={}}if(window.location&&window.location.protocol==="https:"){embedit.redditBaseUrl="https://old.reddit.com"}embedit.video=function(webmUrl,mp4Url){var video=$('<video autoplay playsinline loop controls="true" />');if(webmUrl){video.append($("<source/>").attr("src",webmUrl))}if(mp4Url){video.append($("<source/>").attr("src",mp4Url))}return video};embedit.unsupported=function(url){console.log("Omitting unsupported url: '"+url+"'")};embedit.redGifConvert=function(url,embedFunc){var name=embedit.redGifUrlToId(url);if(!name){console.log("Failed to identify redgif name");return false}const iframeUrl="https://www.redgifs.com/ifr/"+name;embedFunc($('<iframe src="'+iframeUrl+'" frameborder="0" scrolling="no" width="100%" height="100%" allowfullscreen="" style="position:absolute;"></iframe>'));return true};embedit.convertors=[{name:"imgurAlbums",detect:/imgur\.com\/a\/.*/,convert:function(url,embedFunc){embedit.unsupported(url);embedFunc(null);return true}},{name:"imgurGifv",detect:/imgur\.com.*(gif|gifv|mp4|webm)/,convert:function(url,embedFunc){var no_extension=url.replace(/\.\w+$/,"");var webmUrl=no_extension+".webm";var mp4Url=no_extension+".mp4";embedFunc(embedit.video(webmUrl,mp4Url));return true}},{name:"imgurNoExtension",detect:/imgur\.com[^.]+/,convert:function(url,embedFunc){var newUrl=url+".jpg";var image=$("<img />");image.attr("src",newUrl);embedFunc(image);return true}},{name:"redditPost",detect:/reddit\.com\/r\/.*/,convert:function(){return false}},{name:"gfycat",detect:/gfycat\.com.*/,convert:function(url,embedFunc){var name=embedit.gfyUrlToId(url);if(!name)return false;$.ajax({url:"https://api.gfycat.com/v1/gfycats/"+name,dataType:"json",success:function(data){if(!data||!data.gfyItem||!data.gfyItem.webmUrl){embedFunc(null);return}embedFunc(embedit.video(data.gfyItem.webmUrl,data.gfyItem.mp4Url))},error:function(){var newUrl=url.replace("gfycat.com/","redgifs.com/watch/");console.log("gfycat failed load, trying redgif",newUrl);embedit.redGifConvert(newUrl,embedFunc)}});return true}},{name:"redgifs",detect:/redgifs\.com.*/,convert:embedit.redGifConvert},{name:"v.reddit",detect:/v\.redd\.it.*/,convert:function(url,embedFunc){embedFunc(embedit.video(url));return true}},{name:"imageExtension",detect:/\.(png|jpg|jpeg|gif|bmp)$/,convert:function(url,embedFunc){var newElem=$("<img />",{id:"",src:url,alt:""});embedFunc(newElem);return true}},{name:"preview.redd.it",detect:/preview\.redd\.it.*/,convert:function(url,embedFunc){embedFunc(embedit.video(url));return true}}];embedit.embed=function(url,embedFunc){var keys=Object.keys(embedit.convertors);for(var i=0;i<keys.length;i++){var key=keys[i];var convertor=embedit.convertors[key];if(url.match(convertor.detect)){var handled=convertor.convert(url,embedFunc);if(handled)return true}}embedit.unsupported(url);embedFunc(null)};embedit.gfyUrlToId=function(url){var match=url.match(/gfycat.com\/(gifs\/detail\/)?(\w+)/i);if(match&&match.length>2){return match[2]}else{return false}};embedit.redGifUrlToId=function(url){var matches=url.match(/redgifs.com\/watch\/([\w-]+)\/?/i);if(matches&&matches.length>1){return matches[1]}matches=url.match(/redgifs.com\/ifr\/([\w-]+)\/?/i);if(matches&&matches.length>1){return matches[1]}return false};function isImageExtension(url){var goodExtensions=[".jpg",".jpeg",".gif",".bmp",".png"];var dotLocation=url.lastIndexOf(".");if(dotLocation<0){console.log("skipped no dot: "+url);return false}var extension=url.substring(dotLocation);return goodExtensions.indexOf(extension)>=0}embedit.processRedditJson=function(data){var result={children:[],after:null};if(data&&data.length===2&&data[0].data.children.length===1){data=data[0]}if(data&&data.data&&data.data.after){result.after=data.data.after}if(data&&data.data&&data.data.children){result.children=data.data.children}else{}if(result.children.length===0){console.log("What case is this? Does the data have any length? Is this the standard nothing found case? TODO: debug this");result.children=data}return result};embedit.redditItemToPic=function(item){var pic={url:item.data.url||item.data.link_url,title:item.data.title||item.data.link_title,over18:item.data.over_18,subreddit:item.data.subreddit,commentsLink:embedit.redditBaseUrl+item.data.permalink,userLink:item.data.author,data:item.data};if(!embedit.transformRedditData(pic)){return null}return pic};function decodeEntities(encodedString){var translate_re=/&(nbsp|amp|quot|lt|gt);/g;var translate={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"};return encodedString.replace(translate_re,(function(match,entity){return translate[entity]})).replace(/&#(\d+);/gi,(function(match,numStr){var num=parseInt(numStr,10);return String.fromCharCode(num)}))}embedit.transformRedditData=function(pic){pic.type=embedit.imageTypes.image;var http_prefix="http://";var https_prefix="https://";if(pic.url.indexOf("gfycat.com")>=0){pic.type=embedit.imageTypes.gfycat;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("redgifs.com")>=0){pic.type=embedit.imageTypes.redgif;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("//v.redd.it/")>=0){if(pic.data.media){pic.type=embedit.imageTypes.gifv;pic.url=pic.data.media.reddit_video.fallback_url}else if(pic.data.crosspost_parent_list&&pic.data.crosspost_parent_list[0].media){pic.type=embedit.imageTypes.gifv;pic.url=pic.data.crosspost_parent_list[0].media.reddit_video.fallback_url}else{return false}pic.sound=pic.url.substring(0,pic.url.lastIndexOf("/"))+"/DASH_audio.mp4"}else if(pic.url.search(/^http.*imgur.*gifv?$/)>-1){pic.type=embedit.imageTypes.gifv;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("reddit.com/gallery")>=0){console.log("GOTCHA!");var dataSource;if(pic.data.gallery_data&&pic.data.gallery_data.items){dataSource=pic.data}else if(pic.data.crosspost_parent_list&&pic.data.crosspost_parent_list[0]&&pic.data.crosspost_parent_list[0].gallery_data&&pic.data.crosspost_parent_list[0].gallery_data.items){dataSource=pic.data.crosspost_parent_list[0]}var firstItemId=dataSource.gallery_data.items[0].media_id;var encodedUrl=dataSource.media_metadata[firstItemId]["s"]["u"];pic.type=embedit.imageTypes.image;if(encodedUrl===undefined){encodedUrl=dataSource.media_metadata[firstItemId]["s"]["mp4"];pic.type=embedit.imageTypes.gifv}pic.url=decodeEntities(encodedUrl);console.log(pic.url)}else if(isImageExtension(pic.url)){}else{var betterUrl=tryConvertUrl(pic.url);if(betterUrl!==""){pic.url=betterUrl}else{if(window.debug){console.log("cannot display url as image: "+pic.url)}return false}}return true};var tryConvertUrl=function(url){if(url.indexOf("imgur.com")>0||url.indexOf("/gallery/")>0){if(url.indexOf("gifv")>=0){if(url.indexOf("i.")===0){url=url.replace("imgur.com","i.imgur.com")}return url.replace(".gifv",".gif")}if(url.indexOf("/a/")>0||url.indexOf("/gallery/")>0){return""}return url.replace(/r\/[^ /]+\/(\w+)/,"$1")+".jpg"}return""};function browserNodeExport(exported,name){if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=exported}else{if(typeof define==="function"&&define.amd){define([],(function(){return exported}))}else{window[name]=exported}}}browserNodeExport(embedit,"embedit");function fixTagsyoLink(){var subMatch=/\/r\/([a-zA-Z_0-9\-]+)/.exec(window.location.href);if(!subMatch){return}var subName=subMatch[1];var query="SELECT * FROM url WHERE LOWER(channel) = '"+subName.toLowerCase()+"' ORDER BY timestamp DESC !slideshow";var tagsyoLink="http://www.tagsyo.com/q/?q="+encodeURIComponent(query);document.getElementById("tagsyo-link").href=tagsyoLink;console.log("fixed tagsyo link")}fixTagsyoLink();(function(){var method;var noop=function(){};var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];var length=methods.length;window.console=window.console||{};var console=window.console;while(length>0){length-=1;method=methods[length];if(!console[method]){console[method]=noop}}})();if(!Array.indexOf){Array.prototype.indexOf=function(obj){for(var i=0;i<this.length;i++){if(this[i]==obj){return i}}return-1}}!function(e){e.fn.touchwipe=function(t){var n={min_move_x:20,min_move_y:20,wipeLeft:function(){},wipeRight:function(){},wipeUp:function(){},wipeDown:function(){},preventDefaultEvents:!0};return t&&e.extend(n,t),this.each((function(){function e(){this.removeEventListener("touchmove",t),o=null,c=!1}function t(t){if(n.preventDefaultEvents&&t.preventDefault(),t.touches.length>=2)return void e();if(c){var i=t.touches[0].pageX,h=t.touches[0].pageY,s=o-i,a=u-h;Math.abs(s)>=n.min_move_x?(e(),s>0?n.wipeLeft():n.wipeRight()):Math.abs(a)>=n.min_move_y&&(e(),a>0?n.wipeDown():n.wipeUp())}}function i(e){1==e.touches.length&&(o=e.touches[0].pageX,u=e.touches[0].pageY,c=!0,this.addEventListener("touchmove",t,!1))}var o,u,c=!1;"ontouchstart"in document.documentElement&&this.addEventListener("touchstart",i,!1)})),this}}(jQuery);!function(e){if("function"==typeof define&&define.amd)define(e);else if("object"==typeof exports)module.exports=e();else{var n=window.Cookies,t=window.Cookies=e();t.noConflict=function(){return window.Cookies=n,t}}}((function(){function e(){for(var e=0,n={};e<arguments.length;e++){var t=arguments[e];for(var o in t)n[o]=t[o]}return n}function n(t){function o(n,r,i){var c;if(arguments.length>1){if(i=e({path:"/"},o.defaults,i),"number"==typeof i.expires){var s=new Date;s.setMilliseconds(s.getMilliseconds()+864e5*i.expires),i.expires=s}try{c=JSON.stringify(r),/^[\{\[]/.test(c)&&(r=c)}catch(a){}return r=encodeURIComponent(String(r)),r=r.replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)),n=n.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),n=n.replace(/[\(\)]/g,escape),document.cookie=[n,"=",r,i.expires&&"; expires="+i.expires.toUTCString(),i.path&&"; path="+i.path,i.domain&&"; domain="+i.domain,i.secure?"; secure":""].join("")}n||(c={});for(var p=document.cookie?document.cookie.split("; "):[],u=/(%[0-9A-Z]{2})+/g,d=0;d<p.length;d++){var f=p[d].split("="),l=f[0].replace(u,decodeURIComponent),m=f.slice(1).join("=");'"'===m.charAt(0)&&(m=m.slice(1,-1));try{if(m=t&&t(m,l)||m.replace(u,decodeURIComponent),this.json)try{m=JSON.parse(m)}catch(a){}if(n===l){c=m;break}n||(c[l]=m)}catch(a){}}return c}return o.get=o.set=o,o.getJSON=function(){return o.apply({json:!0},[].slice.call(arguments))},o.defaults={},o.remove=function(n,t){o(n,"",e(t,{expires:-1}))},o.withConverter=n,o}return n()}));var rp={};var galleryOffset=0;rp.settings={debug:true,animationSpeed:100,shouldAutoNextSlide:true,timeToNextSlide:15*1e3,cookieDays:300,nsfw:true,sound:false};rp.session={activeIndex:-1,isAnimating:false,nextSlideTimeoutId:null,after:"",foundOneImage:false,loadingNextImages:false};rp.photos=[];rp.blockedUsers=new Set;rp.loadBlockedUsers=async function(){try{const response=await fetch("/api/blocked-users");const data=await response.json();rp.blockedUsers=new Set(data.blockedUsers);if(rp.photos){rp.photos=rp.photos.filter((photo=>!rp.blockedUsers.has(photo.author)));$("#navboxContent").empty();for(var i=0;i<rp.photos.length;i++){addNumberButton(i)}}}catch(error){console.error("Error loading blocked users:",error);toastr.error("Failed to load blocked users list")}};rp.hideCurrentUser=async function(){const currentPhoto=rp.photos[rp.session.activeIndex];if(currentPhoto&&currentPhoto.author){try{await fetch("/api/blocked-users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentPhoto.author})});rp.blockedUsers.add(currentPhoto.author);rp.photos=rp.photos.filter((photo=>!rp.blockedUsers.has(photo.author)));if(rp.blockedUsers.has(currentPhoto.author)){nextSlide()}$("#navboxContent").empty();for(var i=0;i<rp.photos.length;i++){addNumberButton(i)}toastr.success(`Blocked all posts from user: ${currentPhoto.author}`)}catch(error){console.error("Error blocking user:",error);toastr.error("Failed to block user")}}};rp.cache={};$((function(){var pictureSliderId="#pictureSlider";$("#subredditUrl").text("Loading Reddit Slideshow");$("#navboxTitle").text("Loading Reddit Slideshow");var getNextSlideIndex=function(currentIndex,skipCount){if(typeof skipCount!=="number"){var skipCount=1}if(!rp.settings.nsfw){for(var i=currentIndex+skipCount;i<rp.photos.length;i++){if(!rp.photos[i].over18){return i}}return 0}if(isLastImage(currentIndex)&&!rp.session.loadingNextImages){return 0}return currentIndex+skipCount};function nextSlide(skipCount){var next=getNextSlideIndex(rp.session.activeIndex,skipCount);saveHistory(next);startAnimation(next)}function prevSlide(){var index=rp.session.activeIndex-1;if(!rp.settings.nsfw){for(;index>0;index--){if(!rp.photos[index].over18){break}}}saveHistory(index);startAnimation(index)}var autoNextSlide=function(){if(rp.settings.shouldAutoNextSlide){nextSlide()}};function open_in_background(selector){var link=$(selector)[0];if(navigator.userAgent.match(/msie/i)||navigator.userAgent.match(/trident/i)||navigator.userAgent.match(/firefox/i)){window.open(link.href,"_blank")}else{var mev=document.createEvent("MouseEvents");mev.initMouseEvent("click",true,true,window,0,0,0,0,0,true,false,false,true,0,null);link.dispatchEvent(mev)}}$("#pictureSlider").touchwipe({wipeLeft:nextSlide,wipeRight:prevSlide,wipeUp:nextSlide,wipeDown:prevSlide,min_move_x:20,min_move_y:20,preventDefaultEvents:false});var OPENSTATE_ATTR="data-openstate";$(".collapser").click((function(){var state=$(this).attr(OPENSTATE_ATTR);if(state==="open"){$(this).text("+");var arrowLeftPoint=$(this).position().left;$(this).parent().animate({left:"-"+arrowLeftPoint+"px"});$(this).attr(OPENSTATE_ATTR,"closed")}else{$(this).text("-");$(this).parent().animate({left:"0px"});$(this).attr(OPENSTATE_ATTR,"open")}}));var preLoadImages=function(){var args_len=arguments.length;for(var i=args_len;i--;){var cacheImage=document.createElement("img");cacheImage.src=arguments[i]}};var cookieNames={nsfwCookie:"nsfwCookie",shouldAutoNextSlideCookie:"shouldAutoNextSlideCookie",timeToNextSlideCookie:"timeToNextSlideCookie",soundCookie:"soundCookie"};var setCookie=function(c_name,value){Cookies.set(c_name,value,{expires:rp.settings.cookieDays})};var getCookie=function(c_name){return Cookies.get(c_name)};var updateSound=function(){rp.settings.sound=$("#sound").is(":checked");setCookie(cookieNames.soundCookie,rp.settings.sound);var videoTags=document.getElementsByTagName("video");if(videoTags.length===1){videoTags[0].muted=!rp.settings.sound}var audioTags=document.getElementsByTagName("audio");if(audioTags.length===1){audioTags[0].muted=!rp.settings.sound}else{console.log(audioTags)}};var resetNextSlideTimer=function(){clearTimeout(rp.session.nextSlideTimeoutId);rp.session.nextSlideTimeoutId=setTimeout(autoNextSlide,rp.settings.timeToNextSlide)};var updateAutoNext=function(){rp.settings.shouldAutoNextSlide=$("#autoNextSlide").is(":checked");setCookie(cookieNames.shouldAutoNextSlideCookie,rp.settings.shouldAutoNextSlide);resetNextSlideTimer()};var toggleSound=function(){$("#sound").each((function(){this.checked=!this.checked;console.log(this.checked);$(this).trigger("change")}))};var toggleFullScreen=function(){var elem=document.getElementById("page");if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement){if(document.exitFullscreen){document.exitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}}else{if(elem.requestFullscreen){elem.requestFullscreen()}else if(elem.msRequestFullscreen){elem.msRequestFullscreen()}else if(elem.mozRequestFullScreen){elem.mozRequestFullScreen()}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen()}}};var updateNsfw=function(){rp.settings.nsfw=$("#nsfw").is(":checked");setCookie(cookieNames.nsfwCookie,rp.settings.nsfw)};var initState=function(){var nsfwByCookie=getCookie(cookieNames.nsfwCookie);if(nsfwByCookie===undefined){rp.settings.nsfw=true}else{rp.settings.nsfw=nsfwByCookie==="true";$("#nsfw").prop("checked",rp.settings.nsfw)}$("#nsfw").change(updateNsfw);var soundByCookie=getCookie(cookieNames.soundCookie);if(soundByCookie===undefined){rp.settings.sound=false}else{rp.settings.sound=soundByCookie==="true";$("#sound").prop("checked",rp.settings.sound)}$("#sound").change(updateSound);var autoByCookie=getCookie(cookieNames.shouldAutoNextSlideCookie);if(autoByCookie===undefined){updateAutoNext()}else{rp.settings.shouldAutoNextSlide=autoByCookie==="true";$("#autoNextSlide").prop("checked",rp.settings.shouldAutoNextSlide)}$("#autoNextSlide").change(updateAutoNext);var updateTimeToNextSlide=function(){var val=$("#timeToNextSlide").val();rp.settings.timeToNextSlide=parseFloat(val)*1e3;setCookie(cookieNames.timeToNextSlideCookie,val)};var timeByCookie=getCookie(cookieNames.timeToNextSlideCookie);if(timeByCookie===undefined){updateTimeToNextSlide()}else{rp.settings.timeToNextSlide=parseFloat(timeByCookie)*1e3;$("#timeToNextSlide").val(timeByCookie)}$("#fullScreenButton").click(toggleFullScreen);$("#timeToNextSlide").keyup(updateTimeToNextSlide);$("#prevButton").click(prevSlide);$("#nextButton").click(nextSlide);$("#hideUserButton").click((function(){rp.hideCurrentUser()}))};var addNumberButton=function(numberButton){var navboxUls=$(".navbox ul");var thisNavboxUl=navboxUls[navboxUls.length-1];var newListItem=$("<li />").appendTo(thisNavboxUl);numberButton.appendTo(newListItem);navboxUls.append(document.createTextNode(" "))};var addImageSlide=function(item){if(!item.data.is_gallery){var pic=embedit.redditItemToPic(item);if(!pic){return}for(i=0;i<rp.photos.length;i+=1){if(pic.url===rp.photos[i].url){return}}rp.photos.push(pic);rp.session.foundOneImage=true;var i=rp.photos.length-1;var numberButton=$("<a />").html(i+1-galleryOffset).data("index",i).attr("title",rp.photos[i].title).attr("id","numberButton"+(i+1));if(pic.over18){numberButton.addClass("over18")}numberButton.click((function(){showImage($(this))}));numberButton.addClass("numberButton");addNumberButton(numberButton)}else{const x=rp.photos.length+1-galleryOffset;galleryOffset+=item.data.gallery_data.items.length-1;$.each(item.data.gallery_data.items,(function(j,image){pic={title:item.data.title,url:"https://i.redd.it/"+image.media_id+"."+item.data.media_metadata[image.media_id].m.split("/")[1],data:item.data,commentsLink:item.data.url,over18:item.data.over_18,isVideo:item.data.is_video,subreddit:item.data.subreddit,galleryItem:j+1,galleryTotal:item.data.gallery_data.items.length,userLink:item.data.author,type:item.data.media_metadata[image.media_id].m.split("/")[0]};for(i=0;i<rp.photos.length;i+=1){if(pic.url===rp.photos[i].url){return}}rp.photos.push(pic);rp.session.foundOneImage=true}));var i=rp.photos.length-1;var numberButton=$("<a />").html(x).data("index",i-(rp.photos[i].galleryItem-1)).attr("title",rp.photos[i].title).attr("id","numberButton"+(i+1-(rp.photos[i].galleryTotal-1))).addClass("numberButton").addClass("gallery");numberButton.append($("<a />").html("/"+rp.photos[i].galleryTotal).css({fontSize:10}).addClass("galleryCount"));if(pic.over18){numberButton.addClass("over18")}numberButton.click((function(){showImage($(this))}));addNumberButton(numberButton)}};var arrow={left:37,up:38,right:39,down:40};var SPACE=32;var PAGEUP=33;var PAGEDOWN=34;var A_KEY=65;var C_KEY=67;var M_KEY=77;var F_KEY=70;var I_KEY=73;var R_KEY=82;var T_KEY=84;var W_KEY=87;var S_KEY=83;var U_KEY=85;var G_KEY=71;$(document).keyup((async function(e){if(e.ctrlKey){return}var code=e.keyCode?e.keyCode:e.which;switch(code){case C_KEY:$("#controlsDiv .collapser").click();break;case T_KEY:$("#titleDiv .collapser").click();break;case A_KEY:var $ans=$("#autoNextSlide");$ans.prop("checked",!$ans.is(":checked"));updateAutoNext();break;case I_KEY:open_in_background("#navboxLink");break;case U_KEY:open_in_background("#navboxUser");break;case R_KEY:open_in_background("#navboxCommentsLink");break;case F_KEY:toggleFullScreen();break;case M_KEY:toggleSound();break;case PAGEUP:case arrow.left:case arrow.up:case W_KEY:return prevSlide();case PAGEDOWN:case arrow.right:case arrow.down:case SPACE:case S_KEY:return nextSlide();case G_KEY:skipGallery();break}}));var showImage=function(docElem){var imageIndex=docElem.data("index");saveHistory(imageIndex);startAnimation(imageIndex)};var isLastImage=function(imageIndex){if(rp.settings.nsfw){return imageIndex===rp.photos.length-1}else{for(var i=imageIndex+1;i<rp.photos.length;i++){if(!rp.photos[i].over18){return false}}return true}};var preloadNextImage=function(imageIndex){var next=getNextSlideIndex(imageIndex);rp.cache={};if(next<rp.photos.length)rp.cache[next]=createDiv(next)};var lastSavedHistoryState={index:-1,url:""};var scheduledAnimation=null;var loadHistory=function(state){var index;if(state==null||rp.photos[state.index]==null||rp.photos[state.index].url!=state.url){index=0}else{index=state.index;lastSavedHistoryState=state}startAnimation(index)};window.onpopstate=function(event){loadHistory(event.state)};var saveHistory=function(index){if(window.history==null){return}var photo=rp.photos[index];if(index!=lastSavedHistoryState.index&&photo!=null){lastSavedHistoryState={index:index,url:photo.url};history.pushState(lastSavedHistoryState,photo.title)}};var animationFinished=function(){if(scheduledAnimation!=null){var next=scheduledAnimation;scheduledAnimation=null;startAnimation(next)}};var showDefault=function(){if(window.history!=null){loadHistory(history.state)}else{startAnimation(0)}};var startAnimation=async function(imageIndex){resetNextSlideTimer();if(rp.session.isAnimating){scheduledAnimation=imageIndex;return}if(rp.session.activeIndex===imageIndex||imageIndex>rp.photos.length-1||imageIndex<0||rp.session.isAnimating||rp.photos.length===0){return}rp.session.isAnimating=true;await animateNavigationBox(imageIndex);slideBackgroundPhoto(imageIndex);preloadNextImage(imageIndex);rp.session.activeIndex=imageIndex;if(isLastImage(rp.session.activeIndex)&&rp.subredditUrl.indexOf("/imgur")!==0){getRedditImages()}};var toggleNumberButton=async function(imageIndex,turnOn){if(imageIndex<0){return}var photo=rp.photos[imageIndex];if(!photo.galleryItem){var numberButton=$("#numberButton"+(imageIndex+1))}else{var numberButton=$("#numberButton"+(imageIndex+1-(rp.photos[imageIndex].galleryItem-1)))}if(turnOn){numberButton.addClass("active")}else{numberButton.removeClass("active")}};var animateNavigationBox=async function(imageIndex){console.log(imageIndex);var photo=rp.photos[imageIndex];var subreddit="/r/"+photo.subreddit;var user="/u/"+photo.userLink+"/submitted";$("#navboxTitle").html(photo.title);$("#navboxSubreddit").attr("href",embedit.redditBaseUrl+subreddit).html(subreddit);$("#navboxLink").attr("href",photo.url).attr("title",photo.title);$("#navboxCommentsLink").attr("href",photo.commentsLink).attr("title","Comments on reddit");$("#navboxUser").attr("href",window.location.origin+user).attr("user","User on reddit");if(photo.galleryItem){$("#navboxGallery").text("Gallery: "+photo.galleryItem+"/"+photo.galleryTotal)}else{$("#navboxGallery").text("")}document.title=photo.title+" - "+subreddit+" - redditP";await toggleNumberButton(rp.session.activeIndex,false);await toggleNumberButton(imageIndex,true)};var playButton=$('<img id="playButton" src="/images/play.svg" />');playButton.click((function(){if($("video")[0]){$("video")[0].play()}else{reportError("Play button pressed but no video there")}playButton.hide()}));$("#page").append(playButton);playButton.hide();var startPlayingVideo=function(vid_jq){if(rp.settings.shouldAutoNextSlide){clearTimeout(rp.session.nextSlideTimeoutId);vid_jq.removeAttr("loop")}vid_jq[0].muted=!rp.settings.sound;var subTracks=vid_jq[0].textTracks||[];for(var i=0;i<subTracks.length;i++){subTracks[i].mode="hidden"}var onEndFunc=function(){if(rp.settings.shouldAutoNextSlide)nextSlide()};vid_jq.one("ended",onEndFunc);var playPromise=vid_jq[0].play();if(playPromise&&playPromise.catch){playPromise.catch((function(e){if(e.name==="NotAllowedError"){playButton.show()}else{}console.log(e)}))}};var slideBackgroundPhoto=function(imageIndex){var divNode;if(rp.cache[imageIndex]===undefined){divNode=createDiv(imageIndex)}else{divNode=rp.cache[imageIndex]}divNode.prependTo(pictureSliderId);fixRedditVideo(imageIndex);$(pictureSliderId+" div").fadeIn(rp.settings.animationSpeed);var oldDiv=$(pictureSliderId+" div:not(:first)");oldDiv.fadeOut(rp.settings.animationSpeed,(function(){oldDiv.remove();rp.session.isAnimating=false;animationFinished();var maybeVid=$("video");if(maybeVid.length>0){startPlayingVideo(maybeVid)}}))};var fixRedditVideo=function(imageIndex){var photo=rp.photos[imageIndex];if(photo.url.indexOf("//v.redd.it/")<0){return}if(!photo.data.secure_media||!photo.data.secure_media.reddit_video){console.log("Some new reddit videos seem to have a null secure_media. Hmmm.");return}var url=photo.data.secure_media.reddit_video.dash_url;var player=dashjs.MediaPlayer().create();player.initialize(document.querySelector("video"),url,true)};var createDiv=function(imageIndex){var photo=rp.photos[imageIndex];var divNode=$("<div />");if(photo.type===embedit.imageTypes.image){preLoadImages(photo.url);var cssMap=Object();cssMap["display"]="none";cssMap["background-image"]="url("+photo.url+")";cssMap["background-repeat"]="no-repeat";cssMap["background-size"]="contain";cssMap["background-position"]="center";divNode.css(cssMap).addClass("clouds")}else{embedit.embed(photo.url,(function(elem){if(!elem){reportError("Failed to handle url");return divNode}if(photo.url.indexOf("//v.redd.it/")>=0){elem=$('<video autoplay playsinline loop controls="true" />')}divNode.append(elem);$(elem).attr({playsinline:""});if(photo.sound){}elem.width("100%").height("100%");if(elem[0].pause){elem[0].pause()}}))}return divNode};var skipGallery=async function(){photo=rp.photos[rp.session.activeIndex];if(!photo.data.is_gallery){return}var skipCount=photo.galleryTotal-photo.galleryItem+1;nextSlide(skipCount)};var verifyNsfwMakesSense=function(){var nsfwImages=0;for(var i=0;i<rp.photos.length;i++){if(rp.photos[i].over18){nsfwImages+=1}}if(.8<nsfwImages*1/rp.photos.length){rp.settings.nsfw=true;$("#nsfw").prop("checked",rp.settings.nsfw)}};var decodeUrl=function(url){return decodeURIComponent(url.replace(/\+/g," "))};rp.getRestOfUrl=function(){var regexS="(/(?:(?:r/)|(?:imgur/a/)|(?:u(?:ser)?/)|(?:domain/)|(?:search))[^&#?]*)[?]?(.*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.href);if(results===null){return["",""]}else{return[results[1],decodeUrl(results[2])]}};var failCleanup=function(){if(rp.photos.length>0){return}$("#navboxTitle").text("");$("#recommend").css({display:"block"})};var parseQuery=function(queryString){var query={};var pairs=(queryString[0]==="?"?queryString.substr(1):queryString).split("&");for(var i=0;i<pairs.length;i++){var pair=pairs[i].split("=");query[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]||"")}return query};var shuffle=function(arr){var i,j,x;for(i=arr.length-1;i>0;i--){j=Math.floor(Math.random()*(i+1));x=arr[i];arr[i]=arr[j];arr[j]=x}return arr};var isShuffleOn=function(){var query=parseQuery(window.location.search);return!!query.shuffle};var getRedditImages=function(){rp.session.loadingNextImages=true;var subredditUrl=rp.subredditUrl;if(rp.photos.length>0&&(subredditUrl==="/r/randnsfw"||subredditUrl==="/r/random")){subredditUrl="/r/"+rp.photos[0].subreddit}if(subredditUrl.length>0&&subredditUrl[subredditUrl.length-1]!=="/"){subredditUrl+="/"}var jsonUrl=embedit.redditBaseUrl+subredditUrl+".json?"+(rp.session.after?rp.session.after+"&":"")+getVars;var failedAjax=function(){var message="Failed ajax, maybe a bad url? Sorry about that :(";var isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(isFirefox){message="Failed ajax, Firefox try to disable tracking protection from the shield in the URL bar"}reportError(message);failCleanup()};var handleData=function(data){var childrenAndAfter=embedit.processRedditJson(data);var children=childrenAndAfter.children;var after=childrenAndAfter.after;if(children.length===0){reportError("No data from this url :(");return}if(isShuffleOn()){shuffle(children)}$.each(children,(function(i,item){if(!item||!item.data){reportError("invald data item");return}addImageSlide(item)}));verifyNsfwMakesSense();if(!rp.session.foundOneImage){reportError("Sorry, no displayable images found in that url :(")}if(rp.session.activeIndex==-1){showDefault()}if(after){rp.session.after="&after="+after}else{console.log("No more pages to load from this subreddit, reloading the start");var numberButton=$("<span />").addClass("numberButton").text("-");addNumberButton(numberButton)}rp.session.loadingNextImages=false};if(rp.settings.debug)console.log("Ajax requesting: "+jsonUrl);var useJsonP=true;if(useJsonP){jsonUrl+="&jsonp=?"}$.ajax({url:jsonUrl,dataType:useJsonP?"jsonp":"json",jsonp:useJsonP,success:handleData,error:failedAjax,404:failedAjax,timeout:5e3})};var getImgurAlbum=function(url){var albumID=url.match(/.*\/(.+?$)/)[1];var jsonUrl="https://api.imgur.com/3/album/"+albumID;var failedAjax=function(){reportError("Failed ajax, maybe a bad url? Sorry about that :(");failCleanup()};var handleData=function(data){var children=data.data.images;if(children.length===0){reportError("No data from this url :(");return}if(isShuffleOn()){shuffle(children)}$.each(children,(function(i,item){addImageSlide({url:item.link,title:item.title,over18:item.nsfw,commentsLink:""})}));verifyNsfwMakesSense();if(!rp.session.foundOneImage){console.log(jsonUrl);reportError("Sorry, no displayable images found in that url :(")}if(rp.session.activeIndex===-1){showDefault()}rp.session.loadingNextImages=false};$.ajax({url:jsonUrl,dataType:"json",success:handleData,error:failedAjax,404:failedAjax,timeout:5e3,beforeSend:function(xhr){xhr.setRequestHeader("Authorization","Client-ID "+"f2edd1ef8e66eaf")}})};var setupUrls=function(){rp.urlData=rp.getRestOfUrl();rp.subredditUrl=rp.urlData[0];getVars=rp.urlData[1];if(getVars.length>0){getVarsQuestionMark="?"+getVars}else{getVarsQuestionMark=""}rp.subredditUrl=rp.subredditUrl.replace(/.compact/,"");rp.subredditUrl=rp.subredditUrl.replace(/\/{2,}/,"/");var subredditName;if(rp.subredditUrl===""){rp.subredditUrl="/";subredditName="reddit.com"+getVarsQuestionMark}else{subredditName=rp.subredditUrl+getVarsQuestionMark}var visitSubredditUrl=embedit.redditBaseUrl+rp.subredditUrl+getVarsQuestionMark;var displayedSubredditName=subredditName;var capsize=50;if(displayedSubredditName.length>capsize){displayedSubredditName=displayedSubredditName.substr(0,capsize)+"&hellip;"}$("#subredditUrl").html("<a href='"+visitSubredditUrl+"'>sub</a>");document.title="redditP - "+displayedSubredditName};var getVars;var getVarsQuestionMark;initState();rp.loadBlockedUsers();setupUrls();rp.session.foundOneImage=false;if(rp.subredditUrl.indexOf("/imgur")===0){getImgurAlbum(rp.subredditUrl)}else{getRedditImages()}}));function browserNodeExport(exported,name){if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=exported}else{if(typeof define==="function"&&define.amd){define([],(function(){return exported}))}else{window[name]=exported}}}browserNodeExport(rp,"rp");embedit={};embedit.imageTypes={image:"image",gfycat:"gfycat",gifv:"gifv",redgif:"redgif"};embedit.redditBaseUrl="http://old.reddit.com";if(typeof window==="undefined"){var window={}}if(window.location&&window.location.protocol==="https:"){embedit.redditBaseUrl="https://old.reddit.com"}embedit.video=function(webmUrl,mp4Url){var video=$('<video autoplay playsinline loop controls="true" />');if(webmUrl){video.append($("<source/>").attr("src",webmUrl))}if(mp4Url){video.append($("<source/>").attr("src",mp4Url))}return video};embedit.unsupported=function(url){console.log("Omitting unsupported url: '"+url+"'")};embedit.redGifConvert=function(url,embedFunc){var name=embedit.redGifUrlToId(url);if(!name){console.log("Failed to identify redgif name");return false}const iframeUrl="https://www.redgifs.com/ifr/"+name;embedFunc($('<iframe src="'+iframeUrl+'" frameborder="0" scrolling="no" width="100%" height="100%" allowfullscreen="" style="position:absolute;"></iframe>'));return true};embedit.convertors=[{name:"imgurAlbums",detect:/imgur\.com\/a\/.*/,convert:function(url,embedFunc){embedit.unsupported(url);embedFunc(null);return true}},{name:"imgurGifv",detect:/imgur\.com.*(gif|gifv|mp4|webm)/,convert:function(url,embedFunc){var no_extension=url.replace(/\.\w+$/,"");var webmUrl=no_extension+".webm";var mp4Url=no_extension+".mp4";embedFunc(embedit.video(webmUrl,mp4Url));return true}},{name:"imgurNoExtension",detect:/imgur\.com[^.]+/,convert:function(url,embedFunc){var newUrl=url+".jpg";var image=$("<img />");image.attr("src",newUrl);embedFunc(image);return true}},{name:"redditPost",detect:/reddit\.com\/r\/.*/,convert:function(){return false}},{name:"gfycat",detect:/gfycat\.com.*/,convert:function(url,embedFunc){var name=embedit.gfyUrlToId(url);if(!name)return false;$.ajax({url:"https://api.gfycat.com/v1/gfycats/"+name,dataType:"json",success:function(data){if(!data||!data.gfyItem||!data.gfyItem.webmUrl){embedFunc(null);return}embedFunc(embedit.video(data.gfyItem.webmUrl,data.gfyItem.mp4Url))},error:function(){var newUrl=url.replace("gfycat.com/","redgifs.com/watch/");console.log("gfycat failed load, trying redgif",newUrl);embedit.redGifConvert(newUrl,embedFunc)}});return true}},{name:"redgifs",detect:/redgifs\.com.*/,convert:embedit.redGifConvert},{name:"v.reddit",detect:/v\.redd\.it.*/,convert:function(url,embedFunc){embedFunc(embedit.video(url));return true}},{name:"imageExtension",detect:/\.(png|jpg|jpeg|gif|bmp)$/,convert:function(url,embedFunc){var newElem=$("<img />",{id:"",src:url,alt:""});embedFunc(newElem);return true}},{name:"preview.redd.it",detect:/preview\.redd\.it.*/,convert:function(url,embedFunc){embedFunc(embedit.video(url));return true}}];embedit.embed=function(url,embedFunc){var keys=Object.keys(embedit.convertors);for(var i=0;i<keys.length;i++){var key=keys[i];var convertor=embedit.convertors[key];if(url.match(convertor.detect)){var handled=convertor.convert(url,embedFunc);if(handled)return true}}embedit.unsupported(url);embedFunc(null)};embedit.gfyUrlToId=function(url){var match=url.match(/gfycat.com\/(gifs\/detail\/)?(\w+)/i);if(match&&match.length>2){return match[2]}else{return false}};embedit.redGifUrlToId=function(url){var matches=url.match(/redgifs.com\/watch\/([\w-]+)\/?/i);if(matches&&matches.length>1){return matches[1]}matches=url.match(/redgifs.com\/ifr\/([\w-]+)\/?/i);if(matches&&matches.length>1){return matches[1]}return false};function isImageExtension(url){var goodExtensions=[".jpg",".jpeg",".gif",".bmp",".png"];var dotLocation=url.lastIndexOf(".");if(dotLocation<0){console.log("skipped no dot: "+url);return false}var extension=url.substring(dotLocation);return goodExtensions.indexOf(extension)>=0}embedit.processRedditJson=function(data){var result={children:[],after:null};if(data&&data.length===2&&data[0].data.children.length===1){data=data[0]}if(data&&data.data&&data.data.after){result.after=data.data.after}if(data&&data.data&&data.data.children){result.children=data.data.children}else{}if(result.children.length===0){console.log("What case is this? Does the data have any length? Is this the standard nothing found case? TODO: debug this");result.children=data}return result};embedit.redditItemToPic=function(item){var pic={url:item.data.url||item.data.link_url,title:item.data.title||item.data.link_title,over18:item.data.over_18,subreddit:item.data.subreddit,commentsLink:embedit.redditBaseUrl+item.data.permalink,userLink:item.data.author,data:item.data};if(!embedit.transformRedditData(pic)){return null}return pic};function decodeEntities(encodedString){var translate_re=/&(nbsp|amp|quot|lt|gt);/g;var translate={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"};return encodedString.replace(translate_re,(function(match,entity){return translate[entity]})).replace(/&#(\d+);/gi,(function(match,numStr){var num=parseInt(numStr,10);return String.fromCharCode(num)}))}embedit.transformRedditData=function(pic){pic.type=embedit.imageTypes.image;var http_prefix="http://";var https_prefix="https://";if(pic.url.indexOf("gfycat.com")>=0){pic.type=embedit.imageTypes.gfycat;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("redgifs.com")>=0){pic.type=embedit.imageTypes.redgif;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("//v.redd.it/")>=0){if(pic.data.media){pic.type=embedit.imageTypes.gifv;pic.url=pic.data.media.reddit_video.fallback_url}else if(pic.data.crosspost_parent_list&&pic.data.crosspost_parent_list[0].media){pic.type=embedit.imageTypes.gifv;pic.url=pic.data.crosspost_parent_list[0].media.reddit_video.fallback_url}else{return false}pic.sound=pic.url.substring(0,pic.url.lastIndexOf("/"))+"/DASH_audio.mp4"}else if(pic.url.search(/^http.*imgur.*gifv?$/)>-1){pic.type=embedit.imageTypes.gifv;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("reddit.com/gallery")>=0){console.log("GOTCHA!");var dataSource;if(pic.data.gallery_data&&pic.data.gallery_data.items){dataSource=pic.data}else if(pic.data.crosspost_parent_list&&pic.data.crosspost_parent_list[0]&&pic.data.crosspost_parent_list[0].gallery_data&&pic.data.crosspost_parent_list[0].gallery_data.items){dataSource=pic.data.crosspost_parent_list[0]}var firstItemId=dataSource.gallery_data.items[0].media_id;var encodedUrl=dataSource.media_metadata[firstItemId]["s"]["u"];pic.type=embedit.imageTypes.image;if(encodedUrl===undefined){encodedUrl=dataSource.media_metadata[firstItemId]["s"]["mp4"];pic.type=embedit.imageTypes.gifv}pic.url=decodeEntities(encodedUrl);console.log(pic.url)}else if(isImageExtension(pic.url)){}else{var betterUrl=tryConvertUrl(pic.url);if(betterUrl!==""){pic.url=betterUrl}else{if(window.debug){console.log("cannot display url as image: "+pic.url)}return false}}return true};var tryConvertUrl=function(url){if(url.indexOf("imgur.com")>0||url.indexOf("/gallery/")>0){if(url.indexOf("gifv")>=0){if(url.indexOf("i.")===0){url=url.replace("imgur.com","i.imgur.com")}return url.replace(".gifv",".gif")}if(url.indexOf("/a/")>0||url.indexOf("/gallery/")>0){return""}return url.replace(/r\/[^ /]+\/(\w+)/,"$1")+".jpg"}return""};function browserNodeExport(exported,name){if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=exported}else{if(typeof define==="function"&&define.amd){define([],(function(){return exported}))}else{window[name]=exported}}}browserNodeExport(embedit,"embedit");function fixTagsyoLink(){var subMatch=/\/r\/([a-zA-Z_0-9\-]+)/.exec(window.location.href);if(!subMatch){return}var subName=subMatch[1];var query="SELECT * FROM url WHERE LOWER(channel) = '"+subName.toLowerCase()+"' ORDER BY timestamp DESC !slideshow";var tagsyoLink="http://www.tagsyo.com/q/?q="+encodeURIComponent(query);document.getElementById("tagsyo-link").href=tagsyoLink;console.log("fixed tagsyo link")}fixTagsyoLink();(function(){var method;var noop=function(){};var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];var length=methods.length;window.console=window.console||{};var console=window.console;while(length>0){length-=1;method=methods[length];if(!console[method]){console[method]=noop}}})();if(!Array.indexOf){Array.prototype.indexOf=function(obj){for(var i=0;i<this.length;i++){if(this[i]==obj){return i}}return-1}}!function(e){e.fn.touchwipe=function(t){var n={min_move_x:20,min_move_y:20,wipeLeft:function(){},wipeRight:function(){},wipeUp:function(){},wipeDown:function(){},preventDefaultEvents:!0};return t&&e.extend(n,t),this.each((function(){function e(){this.removeEventListener("touchmove",t),o=null,c=!1}function t(t){if(n.preventDefaultEvents&&t.preventDefault(),t.touches.length>=2)return void e();if(c){var i=t.touches[0].pageX,h=t.touches[0].pageY,s=o-i,a=u-h;Math.abs(s)>=n.min_move_x?(e(),s>0?n.wipeLeft():n.wipeRight()):Math.abs(a)>=n.min_move_y&&(e(),a>0?n.wipeDown():n.wipeUp())}}function i(e){1==e.touches.length&&(o=e.touches[0].pageX,u=e.touches[0].pageY,c=!0,this.addEventListener("touchmove",t,!1))}var o,u,c=!1;"ontouchstart"in document.documentElement&&this.addEventListener("touchstart",i,!1)})),this}}(jQuery);!function(e){if("function"==typeof define&&define.amd)define(e);else if("object"==typeof exports)module.exports=e();else{var n=window.Cookies,t=window.Cookies=e();t.noConflict=function(){return window.Cookies=n,t}}}((function(){function e(){for(var e=0,n={};e<arguments.length;e++){var t=arguments[e];for(var o in t)n[o]=t[o]}return n}function n(t){function o(n,r,i){var c;if(arguments.length>1){if(i=e({path:"/"},o.defaults,i),"number"==typeof i.expires){var s=new Date;s.setMilliseconds(s.getMilliseconds()+864e5*i.expires),i.expires=s}try{c=JSON.stringify(r),/^[\{\[]/.test(c)&&(r=c)}catch(a){}return r=encodeURIComponent(String(r)),r=r.replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)),n=n.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),n=n.replace(/[\(\)]/g,escape),document.cookie=[n,"=",r,i.expires&&"; expires="+i.expires.toUTCString(),i.path&&"; path="+i.path,i.domain&&"; domain="+i.domain,i.secure?"; secure":""].join("")}n||(c={});for(var p=document.cookie?document.cookie.split("; "):[],u=/(%[0-9A-Z]{2})+/g,d=0;d<p.length;d++){var f=p[d].split("="),l=f[0].replace(u,decodeURIComponent),m=f.slice(1).join("=");'"'===m.charAt(0)&&(m=m.slice(1,-1));try{if(m=t&&t(m,l)||m.replace(u,decodeURIComponent),this.json)try{m=JSON.parse(m)}catch(a){}if(n===l){c=m;break}n||(c[l]=m)}catch(a){}}return c}return o.get=o.set=o,o.getJSON=function(){return o.apply({json:!0},[].slice.call(arguments))},o.defaults={},o.remove=function(n,t){o(n,"",e(t,{expires:-1}))},o.withConverter=n,o}return n()}));var rp={};var galleryOffset=0;rp.settings={debug:true,animationSpeed:100,shouldAutoNextSlide:true,timeToNextSlide:15*1e3,cookieDays:300,nsfw:true,sound:false};rp.session={activeIndex:-1,isAnimating:false,nextSlideTimeoutId:null,after:"",foundOneImage:false,loadingNextImages:false};rp.photos=[];rp.blockedUsers=new Set;rp.loadBlockedUsers=async function(){try{const response=await fetch("/api/blocked-users");const data=await response.json();rp.blockedUsers=new Set(data.blockedUsers);if(rp.photos){rp.photos=rp.photos.filter((photo=>!rp.blockedUsers.has(photo.author)));$("#navboxContent").empty();for(var i=0;i<rp.photos.length;i++){addNumberButton(i)}}}catch(error){console.error("Error loading blocked users:",error);toastr.error("Failed to load blocked users list")}};rp.hideCurrentUser=async function(){const currentPhoto=rp.photos[rp.session.activeIndex];if(currentPhoto&&currentPhoto.author){try{await fetch("/api/blocked-users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentPhoto.author})});rp.blockedUsers.add(currentPhoto.author);rp.photos=rp.photos.filter((photo=>!rp.blockedUsers.has(photo.author)));if(rp.blockedUsers.has(currentPhoto.author)){nextSlide()}$("#navboxContent").empty();for(var i=0;i<rp.photos.length;i++){addNumberButton(i)}toastr.success(`Blocked all posts from user: ${currentPhoto.author}`)}catch(error){console.error("Error blocking user:",error);toastr.error("Failed to block user")}}};rp.cache={};$((function(){var pictureSliderId="#pictureSlider";$("#subredditUrl").text("Loading Reddit Slideshow");$("#navboxTitle").text("Loading Reddit Slideshow");var getNextSlideIndex=function(currentIndex,skipCount){if(typeof skipCount!=="number"){var skipCount=1}if(!rp.settings.nsfw){for(var i=currentIndex+skipCount;i<rp.photos.length;i++){if(!rp.photos[i].over18){return i}}return 0}if(isLastImage(currentIndex)&&!rp.session.loadingNextImages){return 0}return currentIndex+skipCount};function nextSlide(skipCount){var next=getNextSlideIndex(rp.session.activeIndex,skipCount);saveHistory(next);startAnimation(next)}function prevSlide(){var index=rp.session.activeIndex-1;if(!rp.settings.nsfw){for(;index>0;index--){if(!rp.photos[index].over18){break}}}saveHistory(index);startAnimation(index)}var autoNextSlide=function(){if(rp.settings.shouldAutoNextSlide){nextSlide()}};function open_in_background(selector){var link=$(selector)[0];if(navigator.userAgent.match(/msie/i)||navigator.userAgent.match(/trident/i)||navigator.userAgent.match(/firefox/i)){window.open(link.href,"_blank")}else{var mev=document.createEvent("MouseEvents");mev.initMouseEvent("click",true,true,window,0,0,0,0,0,true,false,false,true,0,null);link.dispatchEvent(mev)}}$("#pictureSlider").touchwipe({wipeLeft:nextSlide,wipeRight:prevSlide,wipeUp:nextSlide,wipeDown:prevSlide,min_move_x:20,min_move_y:20,preventDefaultEvents:false});var OPENSTATE_ATTR="data-openstate";$(".collapser").click((function(){var state=$(this).attr(OPENSTATE_ATTR);if(state==="open"){$(this).text("+");var arrowLeftPoint=$(this).position().left;$(this).parent().animate({left:"-"+arrowLeftPoint+"px"});$(this).attr(OPENSTATE_ATTR,"closed")}else{$(this).text("-");$(this).parent().animate({left:"0px"});$(this).attr(OPENSTATE_ATTR,"open")}}));var preLoadImages=function(){var args_len=arguments.length;for(var i=args_len;i--;){var cacheImage=document.createElement("img");cacheImage.src=arguments[i]}};var cookieNames={nsfwCookie:"nsfwCookie",shouldAutoNextSlideCookie:"shouldAutoNextSlideCookie",timeToNextSlideCookie:"timeToNextSlideCookie",soundCookie:"soundCookie"};var setCookie=function(c_name,value){Cookies.set(c_name,value,{expires:rp.settings.cookieDays})};var getCookie=function(c_name){return Cookies.get(c_name)};var updateSound=function(){rp.settings.sound=$("#sound").is(":checked");setCookie(cookieNames.soundCookie,rp.settings.sound);var videoTags=document.getElementsByTagName("video");if(videoTags.length===1){videoTags[0].muted=!rp.settings.sound}var audioTags=document.getElementsByTagName("audio");if(audioTags.length===1){audioTags[0].muted=!rp.settings.sound}else{console.log(audioTags)}};var resetNextSlideTimer=function(){clearTimeout(rp.session.nextSlideTimeoutId);rp.session.nextSlideTimeoutId=setTimeout(autoNextSlide,rp.settings.timeToNextSlide)};var updateAutoNext=function(){rp.settings.shouldAutoNextSlide=$("#autoNextSlide").is(":checked");setCookie(cookieNames.shouldAutoNextSlideCookie,rp.settings.shouldAutoNextSlide);resetNextSlideTimer()};var toggleSound=function(){$("#sound").each((function(){this.checked=!this.checked;console.log(this.checked);$(this).trigger("change")}))};var toggleFullScreen=function(){var elem=document.getElementById("page");if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement){if(document.exitFullscreen){document.exitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}}else{if(elem.requestFullscreen){elem.requestFullscreen()}else if(elem.msRequestFullscreen){elem.msRequestFullscreen()}else if(elem.mozRequestFullScreen){elem.mozRequestFullScreen()}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen()}}};var updateNsfw=function(){rp.settings.nsfw=$("#nsfw").is(":checked");setCookie(cookieNames.nsfwCookie,rp.settings.nsfw)};var initState=function(){var nsfwByCookie=getCookie(cookieNames.nsfwCookie);if(nsfwByCookie===undefined){rp.settings.nsfw=true}else{rp.settings.nsfw=nsfwByCookie==="true";$("#nsfw").prop("checked",rp.settings.nsfw)}$("#nsfw").change(updateNsfw);var soundByCookie=getCookie(cookieNames.soundCookie);if(soundByCookie===undefined){rp.settings.sound=false}else{rp.settings.sound=soundByCookie==="true";$("#sound").prop("checked",rp.settings.sound)}$("#sound").change(updateSound);var autoByCookie=getCookie(cookieNames.shouldAutoNextSlideCookie);if(autoByCookie===undefined){updateAutoNext()}else{rp.settings.shouldAutoNextSlide=autoByCookie==="true";$("#autoNextSlide").prop("checked",rp.settings.shouldAutoNextSlide)}$("#autoNextSlide").change(updateAutoNext);var updateTimeToNextSlide=function(){var val=$("#timeToNextSlide").val();rp.settings.timeToNextSlide=parseFloat(val)*1e3;setCookie(cookieNames.timeToNextSlideCookie,val)};var timeByCookie=getCookie(cookieNames.timeToNextSlideCookie);if(timeByCookie===undefined){updateTimeToNextSlide()}else{rp.settings.timeToNextSlide=parseFloat(timeByCookie)*1e3;$("#timeToNextSlide").val(timeByCookie)}$("#fullScreenButton").click(toggleFullScreen);$("#timeToNextSlide").keyup(updateTimeToNextSlide);$("#prevButton").click(prevSlide);$("#nextButton").click(nextSlide);$("#hideUserButton").click((function(){rp.hideCurrentUser()}))};var addNumberButton=function(numberButton){var navboxUls=$(".navbox ul");var thisNavboxUl=navboxUls[navboxUls.length-1];var newListItem=$("<li />").appendTo(thisNavboxUl);numberButton.appendTo(newListItem);navboxUls.append(document.createTextNode(" "))};var addImageSlide=function(item){if(!item.data.is_gallery){var pic=embedit.redditItemToPic(item);if(!pic){return}for(i=0;i<rp.photos.length;i+=1){if(pic.url===rp.photos[i].url){return}}rp.photos.push(pic);rp.session.foundOneImage=true;var i=rp.photos.length-1;var numberButton=$("<a />").html(i+1-galleryOffset).data("index",i).attr("title",rp.photos[i].title).attr("id","numberButton"+(i+1));if(pic.over18){numberButton.addClass("over18")}numberButton.click((function(){showImage($(this))}));numberButton.addClass("numberButton");addNumberButton(numberButton)}else{const x=rp.photos.length+1-galleryOffset;galleryOffset+=item.data.gallery_data.items.length-1;$.each(item.data.gallery_data.items,(function(j,image){pic={title:item.data.title,url:"https://i.redd.it/"+image.media_id+"."+item.data.media_metadata[image.media_id].m.split("/")[1],data:item.data,commentsLink:item.data.url,over18:item.data.over_18,isVideo:item.data.is_video,subreddit:item.data.subreddit,galleryItem:j+1,galleryTotal:item.data.gallery_data.items.length,userLink:item.data.author,type:item.data.media_metadata[image.media_id].m.split("/")[0]};for(i=0;i<rp.photos.length;i+=1){if(pic.url===rp.photos[i].url){return}}rp.photos.push(pic);rp.session.foundOneImage=true}));var i=rp.photos.length-1;var numberButton=$("<a />").html(x).data("index",i-(rp.photos[i].galleryItem-1)).attr("title",rp.photos[i].title).attr("id","numberButton"+(i+1-(rp.photos[i].galleryTotal-1))).addClass("numberButton").addClass("gallery");numberButton.append($("<a />").html("/"+rp.photos[i].galleryTotal).css({fontSize:10}).addClass("galleryCount"));if(pic.over18){numberButton.addClass("over18")}numberButton.click((function(){showImage($(this))}));addNumberButton(numberButton)}};var arrow={left:37,up:38,right:39,down:40};var SPACE=32;var PAGEUP=33;var PAGEDOWN=34;var A_KEY=65;var C_KEY=67;var M_KEY=77;var F_KEY=70;var I_KEY=73;var R_KEY=82;var T_KEY=84;var W_KEY=87;var S_KEY=83;var U_KEY=85;var G_KEY=71;$(document).keyup((async function(e){if(e.ctrlKey){return}var code=e.keyCode?e.keyCode:e.which;switch(code){case C_KEY:$("#controlsDiv .collapser").click();break;case T_KEY:$("#titleDiv .collapser").click();break;case A_KEY:var $ans=$("#autoNextSlide");$ans.prop("checked",!$ans.is(":checked"));updateAutoNext();break;case I_KEY:open_in_background("#navboxLink");break;case U_KEY:open_in_background("#navboxUser");break;case R_KEY:open_in_background("#navboxCommentsLink");break;case F_KEY:toggleFullScreen();break;case M_KEY:toggleSound();break;case PAGEUP:case arrow.left:case arrow.up:case W_KEY:return prevSlide();case PAGEDOWN:case arrow.right:case arrow.down:case SPACE:case S_KEY:return nextSlide();case G_KEY:skipGallery();break}}));var showImage=function(docElem){var imageIndex=docElem.data("index");saveHistory(imageIndex);startAnimation(imageIndex)};var isLastImage=function(imageIndex){if(rp.settings.nsfw){return imageIndex===rp.photos.length-1}else{for(var i=imageIndex+1;i<rp.photos.length;i++){if(!rp.photos[i].over18){return false}}return true}};var preloadNextImage=function(imageIndex){var next=getNextSlideIndex(imageIndex);rp.cache={};if(next<rp.photos.length)rp.cache[next]=createDiv(next)};var lastSavedHistoryState={index:-1,url:""};var scheduledAnimation=null;var loadHistory=function(state){var index;if(state==null||rp.photos[state.index]==null||rp.photos[state.index].url!=state.url){index=0}else{index=state.index;lastSavedHistoryState=state}startAnimation(index)};window.onpopstate=function(event){loadHistory(event.state)};var saveHistory=function(index){if(window.history==null){return}var photo=rp.photos[index];if(index!=lastSavedHistoryState.index&&photo!=null){lastSavedHistoryState={index:index,url:photo.url};history.pushState(lastSavedHistoryState,photo.title)}};var animationFinished=function(){if(scheduledAnimation!=null){var next=scheduledAnimation;scheduledAnimation=null;startAnimation(next)}};var showDefault=function(){if(window.history!=null){loadHistory(history.state)}else{startAnimation(0)}};var startAnimation=async function(imageIndex){resetNextSlideTimer();if(rp.session.isAnimating){scheduledAnimation=imageIndex;return}if(rp.session.activeIndex===imageIndex||imageIndex>rp.photos.length-1||imageIndex<0||rp.session.isAnimating||rp.photos.length===0){return}rp.session.isAnimating=true;await animateNavigationBox(imageIndex);slideBackgroundPhoto(imageIndex);preloadNextImage(imageIndex);rp.session.activeIndex=imageIndex;if(isLastImage(rp.session.activeIndex)&&rp.subredditUrl.indexOf("/imgur")!==0){getRedditImages()}};var toggleNumberButton=async function(imageIndex,turnOn){if(imageIndex<0){return}var photo=rp.photos[imageIndex];if(!photo.galleryItem){var numberButton=$("#numberButton"+(imageIndex+1))}else{var numberButton=$("#numberButton"+(imageIndex+1-(rp.photos[imageIndex].galleryItem-1)))}if(turnOn){numberButton.addClass("active")}else{numberButton.removeClass("active")}};var animateNavigationBox=async function(imageIndex){console.log(imageIndex);var photo=rp.photos[imageIndex];var subreddit="/r/"+photo.subreddit;var user="/u/"+photo.userLink+"/submitted";$("#navboxTitle").html(photo.title);$("#navboxSubreddit").attr("href",embedit.redditBaseUrl+subreddit).html(subreddit);$("#navboxLink").attr("href",photo.url).attr("title",photo.title);$("#navboxCommentsLink").attr("href",photo.commentsLink).attr("title","Comments on reddit");$("#navboxUser").attr("href",window.location.origin+user).attr("user","User on reddit");if(photo.galleryItem){$("#navboxGallery").text("Gallery: "+photo.galleryItem+"/"+photo.galleryTotal)}else{$("#navboxGallery").text("")}document.title=photo.title+" - "+subreddit+" - redditP";await toggleNumberButton(rp.session.activeIndex,false);await toggleNumberButton(imageIndex,true)};var playButton=$('<img id="playButton" src="/images/play.svg" />');playButton.click((function(){if($("video")[0]){$("video")[0].play()}else{reportError("Play button pressed but no video there")}playButton.hide()}));$("#page").append(playButton);playButton.hide();var startPlayingVideo=function(vid_jq){if(rp.settings.shouldAutoNextSlide){clearTimeout(rp.session.nextSlideTimeoutId);vid_jq.removeAttr("loop")}vid_jq[0].muted=!rp.settings.sound;var subTracks=vid_jq[0].textTracks||[];for(var i=0;i<subTracks.length;i++){subTracks[i].mode="hidden"}var onEndFunc=function(){if(rp.settings.shouldAutoNextSlide)nextSlide()};vid_jq.one("ended",onEndFunc);var playPromise=vid_jq[0].play();if(playPromise&&playPromise.catch){playPromise.catch((function(e){if(e.name==="NotAllowedError"){playButton.show()}else{}console.log(e)}))}};var slideBackgroundPhoto=function(imageIndex){var divNode;if(rp.cache[imageIndex]===undefined){divNode=createDiv(imageIndex)}else{divNode=rp.cache[imageIndex]}divNode.prependTo(pictureSliderId);fixRedditVideo(imageIndex);$(pictureSliderId+" div").fadeIn(rp.settings.animationSpeed);var oldDiv=$(pictureSliderId+" div:not(:first)");oldDiv.fadeOut(rp.settings.animationSpeed,(function(){oldDiv.remove();rp.session.isAnimating=false;animationFinished();var maybeVid=$("video");if(maybeVid.length>0){startPlayingVideo(maybeVid)}}))};var fixRedditVideo=function(imageIndex){var photo=rp.photos[imageIndex];if(photo.url.indexOf("//v.redd.it/")<0){return}if(!photo.data.secure_media||!photo.data.secure_media.reddit_video){console.log("Some new reddit videos seem to have a null secure_media. Hmmm.");return}var url=photo.data.secure_media.reddit_video.dash_url;var player=dashjs.MediaPlayer().create();player.initialize(document.querySelector("video"),url,true)};var createDiv=function(imageIndex){var photo=rp.photos[imageIndex];var divNode=$("<div />");if(photo.type===embedit.imageTypes.image){preLoadImages(photo.url);var cssMap=Object();cssMap["display"]="none";cssMap["background-image"]="url("+photo.url+")";cssMap["background-repeat"]="no-repeat";cssMap["background-size"]="contain";cssMap["background-position"]="center";divNode.css(cssMap).addClass("clouds")}else{embedit.embed(photo.url,(function(elem){if(!elem){reportError("Failed to handle url");return divNode}if(photo.url.indexOf("//v.redd.it/")>=0){elem=$('<video autoplay playsinline loop controls="true" />')}divNode.append(elem);$(elem).attr({playsinline:""});if(photo.sound){}elem.width("100%").height("100%");if(elem[0].pause){elem[0].pause()}}))}return divNode};var skipGallery=async function(){photo=rp.photos[rp.session.activeIndex];if(!photo.data.is_gallery){return}var skipCount=photo.galleryTotal-photo.galleryItem+1;nextSlide(skipCount)};var verifyNsfwMakesSense=function(){var nsfwImages=0;for(var i=0;i<rp.photos.length;i++){if(rp.photos[i].over18){nsfwImages+=1}}if(.8<nsfwImages*1/rp.photos.length){rp.settings.nsfw=true;$("#nsfw").prop("checked",rp.settings.nsfw)}};var decodeUrl=function(url){return decodeURIComponent(url.replace(/\+/g," "))};rp.getRestOfUrl=function(){var regexS="(/(?:(?:r/)|(?:imgur/a/)|(?:u(?:ser)?/)|(?:domain/)|(?:search))[^&#?]*)[?]?(.*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.href);if(results===null){return["",""]}else{return[results[1],decodeUrl(results[2])]}};var failCleanup=function(){if(rp.photos.length>0){return}$("#navboxTitle").text("");$("#recommend").css({display:"block"})};var parseQuery=function(queryString){var query={};var pairs=(queryString[0]==="?"?queryString.substr(1):queryString).split("&");for(var i=0;i<pairs.length;i++){var pair=pairs[i].split("=");query[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]||"")}return query};var shuffle=function(arr){var i,j,x;for(i=arr.length-1;i>0;i--){j=Math.floor(Math.random()*(i+1));x=arr[i];arr[i]=arr[j];arr[j]=x}return arr};var isShuffleOn=function(){var query=parseQuery(window.location.search);return!!query.shuffle};var getRedditImages=function(){rp.session.loadingNextImages=true;var subredditUrl=rp.subredditUrl;if(rp.photos.length>0&&(subredditUrl==="/r/randnsfw"||subredditUrl==="/r/random")){subredditUrl="/r/"+rp.photos[0].subreddit}if(subredditUrl.length>0&&subredditUrl[subredditUrl.length-1]!=="/"){subredditUrl+="/"}var jsonUrl=embedit.redditBaseUrl+subredditUrl+".json?"+(rp.session.after?rp.session.after+"&":"")+getVars;var failedAjax=function(){var message="Failed ajax, maybe a bad url? Sorry about that :(";var isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(isFirefox){message="Failed ajax, Firefox try to disable tracking protection from the shield in the URL bar"}reportError(message);failCleanup()};var handleData=function(data){var childrenAndAfter=embedit.processRedditJson(data);var children=childrenAndAfter.children;var after=childrenAndAfter.after;if(children.length===0){reportError("No data from this url :(");return}if(isShuffleOn()){shuffle(children)}$.each(children,(function(i,item){if(!item||!item.data){reportError("invald data item");return}addImageSlide(item)}));verifyNsfwMakesSense();if(!rp.session.foundOneImage){reportError("Sorry, no displayable images found in that url :(")}if(rp.session.activeIndex==-1){showDefault()}if(after){rp.session.after="&after="+after}else{console.log("No more pages to load from this subreddit, reloading the start");var numberButton=$("<span />").addClass("numberButton").text("-");addNumberButton(numberButton)}rp.session.loadingNextImages=false};if(rp.settings.debug)console.log("Ajax requesting: "+jsonUrl);var useJsonP=true;if(useJsonP){jsonUrl+="&jsonp=?"}$.ajax({url:jsonUrl,dataType:useJsonP?"jsonp":"json",jsonp:useJsonP,success:handleData,error:failedAjax,404:failedAjax,timeout:5e3})};var getImgurAlbum=function(url){var albumID=url.match(/.*\/(.+?$)/)[1];var jsonUrl="https://api.imgur.com/3/album/"+albumID;var failedAjax=function(){reportError("Failed ajax, maybe a bad url? Sorry about that :(");failCleanup()};var handleData=function(data){var children=data.data.images;if(children.length===0){reportError("No data from this url :(");return}if(isShuffleOn()){shuffle(children)}$.each(children,(function(i,item){addImageSlide({url:item.link,title:item.title,over18:item.nsfw,commentsLink:""})}));verifyNsfwMakesSense();if(!rp.session.foundOneImage){console.log(jsonUrl);reportError("Sorry, no displayable images found in that url :(")}if(rp.session.activeIndex===-1){showDefault()}rp.session.loadingNextImages=false};$.ajax({url:jsonUrl,dataType:"json",success:handleData,error:failedAjax,404:failedAjax,timeout:5e3,beforeSend:function(xhr){xhr.setRequestHeader("Authorization","Client-ID "+"f2edd1ef8e66eaf")}})};var setupUrls=function(){rp.urlData=rp.getRestOfUrl();rp.subredditUrl=rp.urlData[0];getVars=rp.urlData[1];if(getVars.length>0){getVarsQuestionMark="?"+getVars}else{getVarsQuestionMark=""}rp.subredditUrl=rp.subredditUrl.replace(/.compact/,"");rp.subredditUrl=rp.subredditUrl.replace(/\/{2,}/,"/");var subredditName;if(rp.subredditUrl===""){rp.subredditUrl="/";subredditName="reddit.com"+getVarsQuestionMark}else{subredditName=rp.subredditUrl+getVarsQuestionMark}var visitSubredditUrl=embedit.redditBaseUrl+rp.subredditUrl+getVarsQuestionMark;var displayedSubredditName=subredditName;var capsize=50;if(displayedSubredditName.length>capsize){displayedSubredditName=displayedSubredditName.substr(0,capsize)+"&hellip;"}$("#subredditUrl").html("<a href='"+visitSubredditUrl+"'>sub</a>");document.title="redditP - "+displayedSubredditName};var getVars;var getVarsQuestionMark;initState();rp.loadBlockedUsers();setupUrls();rp.session.foundOneImage=false;if(rp.subredditUrl.indexOf("/imgur")===0){getImgurAlbum(rp.subredditUrl)}else{getRedditImages()}}));function browserNodeExport(exported,name){if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=exported}else{if(typeof define==="function"&&define.amd){define([],(function(){return exported}))}else{window[name]=exported}}}browserNodeExport(rp,"rp");embedit={};embedit.imageTypes={image:"image",gfycat:"gfycat",gifv:"gifv",redgif:"redgif"};embedit.redditBaseUrl="http://old.reddit.com";if(typeof window==="undefined"){var window={}}if(window.location&&window.location.protocol==="https:"){embedit.redditBaseUrl="https://old.reddit.com"}embedit.video=function(webmUrl,mp4Url){var video=$('<video autoplay playsinline loop controls="true" />');if(webmUrl){video.append($("<source/>").attr("src",webmUrl))}if(mp4Url){video.append($("<source/>").attr("src",mp4Url))}return video};embedit.unsupported=function(url){console.log("Omitting unsupported url: '"+url+"'")};embedit.redGifConvert=function(url,embedFunc){var name=embedit.redGifUrlToId(url);if(!name){console.log("Failed to identify redgif name");return false}const iframeUrl="https://www.redgifs.com/ifr/"+name;embedFunc($('<iframe src="'+iframeUrl+'" frameborder="0" scrolling="no" width="100%" height="100%" allowfullscreen="" style="position:absolute;"></iframe>'));return true};embedit.convertors=[{name:"imgurAlbums",detect:/imgur\.com\/a\/.*/,convert:function(url,embedFunc){embedit.unsupported(url);embedFunc(null);return true}},{name:"imgurGifv",detect:/imgur\.com.*(gif|gifv|mp4|webm)/,convert:function(url,embedFunc){var no_extension=url.replace(/\.\w+$/,"");var webmUrl=no_extension+".webm";var mp4Url=no_extension+".mp4";embedFunc(embedit.video(webmUrl,mp4Url));return true}},{name:"imgurNoExtension",detect:/imgur\.com[^.]+/,convert:function(url,embedFunc){var newUrl=url+".jpg";var image=$("<img />");image.attr("src",newUrl);embedFunc(image);return true}},{name:"redditPost",detect:/reddit\.com\/r\/.*/,convert:function(){return false}},{name:"gfycat",detect:/gfycat\.com.*/,convert:function(url,embedFunc){var name=embedit.gfyUrlToId(url);if(!name)return false;$.ajax({url:"https://api.gfycat.com/v1/gfycats/"+name,dataType:"json",success:function(data){if(!data||!data.gfyItem||!data.gfyItem.webmUrl){embedFunc(null);return}embedFunc(embedit.video(data.gfyItem.webmUrl,data.gfyItem.mp4Url))},error:function(){var newUrl=url.replace("gfycat.com/","redgifs.com/watch/");console.log("gfycat failed load, trying redgif",newUrl);embedit.redGifConvert(newUrl,embedFunc)}});return true}},{name:"redgifs",detect:/redgifs\.com.*/,convert:embedit.redGifConvert},{name:"v.reddit",detect:/v\.redd\.it.*/,convert:function(url,embedFunc){embedFunc(embedit.video(url));return true}},{name:"imageExtension",detect:/\.(png|jpg|jpeg|gif|bmp)$/,convert:function(url,embedFunc){var newElem=$("<img />",{id:"",src:url,alt:""});embedFunc(newElem);return true}},{name:"preview.redd.it",detect:/preview\.redd\.it.*/,convert:function(url,embedFunc){embedFunc(embedit.video(url));return true}}];embedit.embed=function(url,embedFunc){var keys=Object.keys(embedit.convertors);for(var i=0;i<keys.length;i++){var key=keys[i];var convertor=embedit.convertors[key];if(url.match(convertor.detect)){var handled=convertor.convert(url,embedFunc);if(handled)return true}}embedit.unsupported(url);embedFunc(null)};embedit.gfyUrlToId=function(url){var match=url.match(/gfycat.com\/(gifs\/detail\/)?(\w+)/i);if(match&&match.length>2){return match[2]}else{return false}};embedit.redGifUrlToId=function(url){var matches=url.match(/redgifs.com\/watch\/([\w-]+)\/?/i);if(matches&&matches.length>1){return matches[1]}matches=url.match(/redgifs.com\/ifr\/([\w-]+)\/?/i);if(matches&&matches.length>1){return matches[1]}return false};function isImageExtension(url){var goodExtensions=[".jpg",".jpeg",".gif",".bmp",".png"];var dotLocation=url.lastIndexOf(".");if(dotLocation<0){console.log("skipped no dot: "+url);return false}var extension=url.substring(dotLocation);return goodExtensions.indexOf(extension)>=0}embedit.processRedditJson=function(data){var result={children:[],after:null};if(data&&data.length===2&&data[0].data.children.length===1){data=data[0]}if(data&&data.data&&data.data.after){result.after=data.data.after}if(data&&data.data&&data.data.children){result.children=data.data.children}else{}if(result.children.length===0){console.log("What case is this? Does the data have any length? Is this the standard nothing found case? TODO: debug this");result.children=data}return result};embedit.redditItemToPic=function(item){var pic={url:item.data.url||item.data.link_url,title:item.data.title||item.data.link_title,over18:item.data.over_18,subreddit:item.data.subreddit,commentsLink:embedit.redditBaseUrl+item.data.permalink,userLink:item.data.author,data:item.data};if(!embedit.transformRedditData(pic)){return null}return pic};function decodeEntities(encodedString){var translate_re=/&(nbsp|amp|quot|lt|gt);/g;var translate={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"};return encodedString.replace(translate_re,(function(match,entity){return translate[entity]})).replace(/&#(\d+);/gi,(function(match,numStr){var num=parseInt(numStr,10);return String.fromCharCode(num)}))}embedit.transformRedditData=function(pic){pic.type=embedit.imageTypes.image;var http_prefix="http://";var https_prefix="https://";if(pic.url.indexOf("gfycat.com")>=0){pic.type=embedit.imageTypes.gfycat;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("redgifs.com")>=0){pic.type=embedit.imageTypes.redgif;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("//v.redd.it/")>=0){if(pic.data.media){pic.type=embedit.imageTypes.gifv;pic.url=pic.data.media.reddit_video.fallback_url}else if(pic.data.crosspost_parent_list&&pic.data.crosspost_parent_list[0].media){pic.type=embedit.imageTypes.gifv;pic.url=pic.data.crosspost_parent_list[0].media.reddit_video.fallback_url}else{return false}pic.sound=pic.url.substring(0,pic.url.lastIndexOf("/"))+"/DASH_audio.mp4"}else if(pic.url.search(/^http.*imgur.*gifv?$/)>-1){pic.type=embedit.imageTypes.gifv;pic.url=pic.url.replace(http_prefix,https_prefix)}else if(pic.url.indexOf("reddit.com/gallery")>=0){console.log("GOTCHA!");var dataSource;if(pic.data.gallery_data&&pic.data.gallery_data.items){dataSource=pic.data}else if(pic.data.crosspost_parent_list&&pic.data.crosspost_parent_list[0]&&pic.data.crosspost_parent_list[0].gallery_data&&pic.data.crosspost_parent_list[0].gallery_data.items){dataSource=pic.data.crosspost_parent_list[0]}var firstItemId=dataSource.gallery_data.items[0].media_id;var encodedUrl=dataSource.media_metadata[firstItemId]["s"]["u"];pic.type=embedit.imageTypes.image;if(encodedUrl===undefined){encodedUrl=dataSource.media_metadata[firstItemId]["s"]["mp4"];pic.type=embedit.imageTypes.gifv}pic.url=decodeEntities(encodedUrl);console.log(pic.url)}else if(isImageExtension(pic.url)){}else{var betterUrl=tryConvertUrl(pic.url);if(betterUrl!==""){pic.url=betterUrl}else{if(window.debug){console.log("cannot display url as image: "+pic.url)}return false}}return true};var tryConvertUrl=function(url){if(url.indexOf("imgur.com")>0||url.indexOf("/gallery/")>0){if(url.indexOf("gifv")>=0){if(url.indexOf("i.")===0){url=url.replace("imgur.com","i.imgur.com")}return url.replace(".gifv",".gif")}if(url.indexOf("/a/")>0||url.indexOf("/gallery/")>0){return""}return url.replace(/r\/[^ /]+\/(\w+)/,"$1")+".jpg"}return""};function browserNodeExport(exported,name){if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=exported}else{if(typeof define==="function"&&define.amd){define([],(function(){return exported}))}else{window[name]=exported}}}browserNodeExport(embedit,"embedit");function fixTagsyoLink(){var subMatch=/\/r\/([a-zA-Z_0-9\-]+)/.exec(window.location.href);if(!subMatch){return}var subName=subMatch[1];var query="SELECT * FROM url WHERE LOWER(channel) = '"+subName.toLowerCase()+"' ORDER BY timestamp DESC !slideshow";var tagsyoLink="http://www.tagsyo.com/q/?q="+encodeURIComponent(query);document.getElementById("tagsyo-link").href=tagsyoLink;console.log("fixed tagsyo link")}fixTagsyoLink();(function(){var method;var noop=function(){};var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];var length=methods.length;window.console=window.console||{};var console=window.console;while(length>0){length-=1;method=methods[length];if(!console[method]){console[method]=noop}}})();if(!Array.indexOf){Array.prototype.indexOf=function(obj){for(var i=0;i<this.length;i++){if(this[i]==obj){return i}}return-1}}!function(e){e.fn.touchwipe=function(t){var n={min_move_x:20,min_move_y:20,wipeLeft:function(){},wipeRight:function(){},wipeUp:function(){},wipeDown:function(){},preventDefaultEvents:!0};return t&&e.extend(n,t),this.each((function(){function e(){this.removeEventListener("touchmove",t),o=null,c=!1}function t(t){if(n.preventDefaultEvents&&t.preventDefault(),t.touches.length>=2)return void e();if(c){var i=t.touches[0].pageX,h=t.touches[0].pageY,s=o-i,a=u-h;Math.abs(s)>=n.min_move_x?(e(),s>0?n.wipeLeft():n.wipeRight()):Math.abs(a)>=n.min_move_y&&(e(),a>0?n.wipeDown():n.wipeUp())}}function i(e){1==e.touches.length&&(o=e.touches[0].pageX,u=e.touches[0].pageY,c=!0,this.addEventListener("touchmove",t,!1))}var o,u,c=!1;"ontouchstart"in document.documentElement&&this.addEventListener("touchstart",i,!1)})),this}}(jQuery);!function(e){if("function"==typeof define&&define.amd)define(e);else if("object"==typeof exports)module.exports=e();else{var n=window.Cookies,t=window.Cookies=e();t.noConflict=function(){return window.Cookies=n,t}}}((function(){function e(){for(var e=0,n={};e<arguments.length;e++){var t=arguments[e];for(var o in t)n[o]=t[o]}return n}function n(t){function o(n,r,i){var c;if(arguments.length>1){if(i=e({path:"/"},o.defaults,i),"number"==typeof i.expires){var s=new Date;s.setMilliseconds(s.getMilliseconds()+864e5*i.expires),i.expires=s}try{c=JSON.stringify(r),/^[\{\[]/.test(c)&&(r=c)}catch(a){}return r=encodeURIComponent(String(r)),r=r.replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)),n=n.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),n=n.replace(/[\(\)]/g,escape),document.cookie=[n,"=",r,i.expires&&"; expires="+i.expires.toUTCString(),i.path&&"; path="+i.path,i.domain&&"; domain="+i.domain,i.secure?"; secure":""].join("")}n||(c={});for(var p=document.cookie?document.cookie.split("; "):[],u=/(%[0-9A-Z]{2})+/g,d=0;d<p.length;d++){var f=p[d].split("="),l=f[0].replace(u,decodeURIComponent),m=f.slice(1).join("=");'"'===m.charAt(0)&&(m=m.slice(1,-1));try{if(m=t&&t(m,l)||m.replace(u,decodeURIComponent),this.json)try{m=JSON.parse(m)}catch(a){}if(n===l){c=m;break}n||(c[l]=m)}catch(a){}}return c}return o.get=o.set=o,o.getJSON=function(){return o.apply({json:!0},[].slice.call(arguments))},o.defaults={},o.remove=function(n,t){o(n,"",e(t,{expires:-1}))},o.withConverter=n,o}return n()}));var rp={};var galleryOffset=0;rp.settings={debug:true,animationSpeed:100,shouldAutoNextSlide:true,timeToNextSlide:15*1e3,cookieDays:300,nsfw:true,sound:false};rp.session={activeIndex:-1,isAnimating:false,nextSlideTimeoutId:null,after:"",foundOneImage:false,loadingNextImages:false};rp.photos=[];rp.blockedUsers=new Set;rp.loadBlockedUsers=async function(){try{const response=await fetch("/api/blocked-users");const data=await response.json();rp.blockedUsers=new Set(data.blockedUsers);if(rp.photos){rp.photos=rp.photos.filter((photo=>!rp.blockedUsers.has(photo.author)));$("#navboxContent").empty();for(var i=0;i<rp.photos.length;i++){addNumberButton(i)}}}catch(error){console.error("Error loading blocked users:",error);toastr.error("Failed to load blocked users list")}};rp.hideCurrentUser=async function(){const currentPhoto=rp.photos[rp.session.activeIndex];if(currentPhoto&&currentPhoto.author){try{await fetch("/api/blocked-users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentPhoto.author})});rp.blockedUsers.add(currentPhoto.author);rp.photos=rp.photos.filter((photo=>!rp.blockedUsers.has(photo.author)));if(rp.blockedUsers.has(currentPhoto.author)){nextSlide()}$("#navboxContent").empty();for(var i=0;i<rp.photos.length;i++){addNumberButton(i)}toastr.success(`Blocked all posts from user: ${currentPhoto.author}`)}catch(error){console.error("Error blocking user:",error);toastr.error("Failed to block user")}}};rp.cache={};$((function(){var pictureSliderId="#pictureSlider";$("#subredditUrl").text("Loading Reddit Slideshow");$("#navboxTitle").text("Loading Reddit Slideshow");var getNextSlideIndex=function(currentIndex,skipCount){if(typeof skipCount!=="number"){var skipCount=1}if(!rp.settings.nsfw){for(var i=currentIndex+skipCount;i<rp.photos.length;i++){if(!rp.photos[i].over18){return i}}return 0}if(isLastImage(currentIndex)&&!rp.session.loadingNextImages){return 0}return currentIndex+skipCount};function nextSlide(skipCount){var next=getNextSlideIndex(rp.session.activeIndex,skipCount);saveHistory(next);startAnimation(next)}function prevSlide(){var index=rp.session.activeIndex-1;if(!rp.settings.nsfw){for(;index>0;index--){if(!rp.photos[index].over18){break}}}saveHistory(index);startAnimation(index)}var autoNextSlide=function(){if(rp.settings.shouldAutoNextSlide){nextSlide()}};function open_in_background(selector){var link=$(selector)[0];if(navigator.userAgent.match(/msie/i)||navigator.userAgent.match(/trident/i)||navigator.userAgent.match(/firefox/i)){window.open(link.href,"_blank")}else{var mev=document.createEvent("MouseEvents");mev.initMouseEvent("click",true,true,window,0,0,0,0,0,true,false,false,true,0,null);link.dispatchEvent(mev)}}$("#pictureSlider").touchwipe({wipeLeft:nextSlide,wipeRight:prevSlide,wipeUp:nextSlide,wipeDown:prevSlide,min_move_x:20,min_move_y:20,preventDefaultEvents:false});var OPENSTATE_ATTR="data-openstate";$(".collapser").click((function(){var state=$(this).attr(OPENSTATE_ATTR);if(state==="open"){$(this).text("+");var arrowLeftPoint=$(this).position().left;$(this).parent().animate({left:"-"+arrowLeftPoint+"px"});$(this).attr(OPENSTATE_ATTR,"closed")}else{$(this).text("-");$(this).parent().animate({left:"0px"});$(this).attr(OPENSTATE_ATTR,"open")}}));var preLoadImages=function(){var args_len=arguments.length;for(var i=args_len;i--;){var cacheImage=document.createElement("img");cacheImage.src=arguments[i]}};var cookieNames={nsfwCookie:"nsfwCookie",shouldAutoNextSlideCookie:"shouldAutoNextSlideCookie",timeToNextSlideCookie:"timeToNextSlideCookie",soundCookie:"soundCookie"};var setCookie=function(c_name,value){Cookies.set(c_name,value,{expires:rp.settings.cookieDays})};var getCookie=function(c_name){return Cookies.get(c_name)};var updateSound=function(){rp.settings.sound=$("#sound").is(":checked");setCookie(cookieNames.soundCookie,rp.settings.sound);var videoTags=document.getElementsByTagName("video");if(videoTags.length===1){videoTags[0].muted=!rp.settings.sound}var audioTags=document.getElementsByTagName("audio");if(audioTags.length===1){audioTags[0].muted=!rp.settings.sound}else{console.log(audioTags)}};var resetNextSlideTimer=function(){clearTimeout(rp.session.nextSlideTimeoutId);rp.session.nextSlideTimeoutId=setTimeout(autoNextSlide,rp.settings.timeToNextSlide)};var updateAutoNext=function(){rp.settings.shouldAutoNextSlide=$("#autoNextSlide").is(":checked");setCookie(cookieNames.shouldAutoNextSlideCookie,rp.settings.shouldAutoNextSlide);resetNextSlideTimer()};var toggleSound=function(){$("#sound").each((function(){this.checked=!this.checked;console.log(this.checked);$(this).trigger("change")}))};var toggleFullScreen=function(){var elem=document.getElementById("page");if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement){if(document.exitFullscreen){document.exitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}}else{if(elem.requestFullscreen){elem.requestFullscreen()}else if(elem.msRequestFullscreen){elem.msRequestFullscreen()}else if(elem.mozRequestFullScreen){elem.mozRequestFullScreen()}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen()}}};var updateNsfw=function(){rp.settings.nsfw=$("#nsfw").is(":checked");setCookie(cookieNames.nsfwCookie,rp.settings.nsfw)};var initState=function(){var nsfwByCookie=getCookie(cookieNames.nsfwCookie);if(nsfwByCookie===undefined){rp.settings.nsfw=true}else{rp.settings.nsfw=nsfwByCookie==="true";$("#nsfw").prop("checked",rp.settings.nsfw)}$("#nsfw").change(updateNsfw);var soundByCookie=getCookie(cookieNames.soundCookie);if(soundByCookie===undefined){rp.settings.sound=false}else{rp.settings.sound=soundByCookie==="true";$("#sound").prop("checked",rp.settings.sound)}$("#sound").change(updateSound);var autoByCookie=getCookie(cookieNames.shouldAutoNextSlideCookie);if(autoByCookie===undefined){updateAutoNext()}else{rp.settings.shouldAutoNextSlide=autoByCookie==="true";$("#autoNextSlide").prop("checked",rp.settings.shouldAutoNextSlide)}$("#autoNextSlide").change(updateAutoNext);var updateTimeToNextSlide=function(){var val=$("#timeToNextSlide").val();rp.settings.timeToNextSlide=parseFloat(val)*1e3;setCookie(cookieNames.timeToNextSlideCookie,val)};var timeByCookie=getCookie(cookieNames.timeToNextSlideCookie);if(timeByCookie===undefined){updateTimeToNextSlide()}else{rp.settings.timeToNextSlide=parseFloat(timeByCookie)*1e3;$("#timeToNextSlide").val(timeByCookie)}$("#fullScreenButton").click(toggleFullScreen);$("#timeToNextSlide").keyup(updateTimeToNextSlide);$("#prevButton").click(prevSlide);$("#nextButton").click(nextSlide);$("#hideUserButton").click((function(){rp.hideCurrentUser()}))};var addNumberButton=function(numberButton){var navboxUls=$(".navbox ul");var thisNavboxUl=navboxUls[navboxUls.length-1];var newListItem=$("<li />").appendTo(thisNavboxUl);numberButton.appendTo(newListItem);navboxUls.append(document.createTextNode(" "))};var addImageSlide=function(item){if(!item.data.is_gallery){var pic=embedit.redditItemToPic(item);if(!pic){return}for(i=0;i<rp.photos.length;i+=1){if(pic.url===rp.photos[i].url){return}}rp.photos.push(pic);rp.session.foundOneImage=true;var i=rp.photos.length-1;var numberButton=$("<a />").html(i+1-galleryOffset).data("index",i).attr("title",rp.photos[i].title).attr("id","numberButton"+(i+1));if(pic.over18){numberButton.addClass("over18")}numberButton.click((function(){showImage($(this))}));numberButton.addClass("numberButton");addNumberButton(numberButton)}else{const x=rp.photos.length+1-galleryOffset;galleryOffset+=item.data.gallery_data.items.length-1;$.each(item.data.gallery_data.items,(function(j,image){pic={title:item.data.title,url:"https://i.redd.it/"+image.media_id+"."+item.data.media_metadata[image.media_id].m.split("/")[1],data:item.data,commentsLink:item.data.url,over18:item.data.over_18,isVideo:item.data.is_video,subreddit:item.data.subreddit,galleryItem:j+1,galleryTotal:item.data.gallery_data.items.length,userLink:item.data.author,type:item.data.media_metadata[image.media_id].m.split("/")[0]};for(i=0;i<rp.photos.length;i+=1){if(pic.url===rp.photos[i].url){return}}rp.photos.push(pic);rp.session.foundOneImage=true}));var i=rp.photos.length-1;var numberButton=$("<a />").html(x).data("index",i-(rp.photos[i].galleryItem-1)).attr("title",rp.photos[i].title).attr("id","numberButton"+(i+1-(rp.photos[i].galleryTotal-1))).addClass("numberButton").addClass("gallery");numberButton.append($("<a />").html("/"+rp.photos[i].galleryTotal).css({fontSize:10}).addClass("galleryCount"));if(pic.over18){numberButton.addClass("over18")}numberButton.click((function(){showImage($(this))}));addNumberButton(numberButton)}};var arrow={left:37,up:38,right:39,down:40};var SPACE=32;var PAGEUP=33;var PAGEDOWN=34;var A_KEY=65;var C_KEY=67;var M_KEY=77;var F_KEY=70;var I_KEY=73;var R_KEY=82;var T_KEY=84;var W_KEY=87;var S_KEY=83;var U_KEY=85;var G_KEY=71;$(document).keyup((async function(e){if(e.ctrlKey){return}var code=e.keyCode?e.keyCode:e.which;switch(code){case C_KEY:$("#controlsDiv .collapser").click();break;case T_KEY:$("#titleDiv .collapser").click();break;case A_KEY:var $ans=$("#autoNextSlide");$ans.prop("checked",!$ans.is(":checked"));updateAutoNext();break;case I_KEY:open_in_background("#navboxLink");break;case U_KEY:open_in_background("#navboxUser");break;case R_KEY:open_in_background("#navboxCommentsLink");break;case F_KEY:toggleFullScreen();break;case M_KEY:toggleSound();break;case PAGEUP:case arrow.left:case arrow.up:case W_KEY:return prevSlide();case PAGEDOWN:case arrow.right:case arrow.down:case SPACE:case S_KEY:return nextSlide();case G_KEY:skipGallery();break}}));var showImage=function(docElem){var imageIndex=docElem.data("index");saveHistory(imageIndex);startAnimation(imageIndex)};var isLastImage=function(imageIndex){if(rp.settings.nsfw){return imageIndex===rp.photos.length-1}else{for(var i=imageIndex+1;i<rp.photos.length;i++){if(!rp.photos[i].over18){return false}}return true}};var preloadNextImage=function(imageIndex){var next=getNextSlideIndex(imageIndex);rp.cache={};if(next<rp.photos.length)rp.cache[next]=createDiv(next)};var lastSavedHistoryState={index:-1,url:""};var scheduledAnimation=null;var loadHistory=function(state){var index;if(state==null||rp.photos[state.index]==null||rp.photos[state.index].url!=state.url){index=0}else{index=state.index;lastSavedHistoryState=state}startAnimation(index)};window.onpopstate=function(event){loadHistory(event.state)};var saveHistory=function(index){if(window.history==null){return}var photo=rp.photos[index];if(index!=lastSavedHistoryState.index&&photo!=null){lastSavedHistoryState={index:index,url:photo.url};history.pushState(lastSavedHistoryState,photo.title)}};var animationFinished=function(){if(scheduledAnimation!=null){var next=scheduledAnimation;scheduledAnimation=null;startAnimation(next)}};var showDefault=function(){if(window.history!=null){loadHistory(history.state)}else{startAnimation(0)}};var startAnimation=async function(imageIndex){resetNextSlideTimer();if(rp.session.isAnimating){scheduledAnimation=imageIndex;return}if(rp.session.activeIndex===imageIndex||imageIndex>rp.photos.length-1||imageIndex<0||rp.session.isAnimating||rp.photos.length===0){return}rp.session.isAnimating=true;await animateNavigationBox(imageIndex);slideBackgroundPhoto(imageIndex);preloadNextImage(imageIndex);rp.session.activeIndex=imageIndex;if(isLastImage(rp.session.activeIndex)&&rp.subredditUrl.indexOf("/imgur")!==0){getRedditImages()}};var toggleNumberButton=async function(imageIndex,turnOn){if(imageIndex<0){return}var photo=rp.photos[imageIndex];if(!photo.galleryItem){var numberButton=$("#numberButton"+(imageIndex+1))}else{var numberButton=$("#numberButton"+(imageIndex+1-(rp.photos[imageIndex].galleryItem-1)))}if(turnOn){numberButton.addClass("active")}else{numberButton.removeClass("active")}};var animateNavigationBox=async function(imageIndex){console.log(imageIndex);var photo=rp.photos[imageIndex];var subreddit="/r/"+photo.subreddit;var user="/u/"+photo.userLink+"/submitted";$("#navboxTitle").html(photo.title);$("#navboxSubreddit").attr("href",embedit.redditBaseUrl+subreddit).html(subreddit);$("#navboxLink").attr("href",photo.url).attr("title",photo.title);$("#navboxCommentsLink").attr("href",photo.commentsLink).attr("title","Comments on reddit");$("#navboxUser").attr("href",window.location.origin+user).attr("user","User on reddit");if(photo.galleryItem){$("#navboxGallery").text("Gallery: "+photo.galleryItem+"/"+photo.galleryTotal)}else{$("#navboxGallery").text("")}document.title=photo.title+" - "+subreddit+" - redditP";await toggleNumberButton(rp.session.activeIndex,false);await toggleNumberButton(imageIndex,true)};var playButton=$('<img id="playButton" src="/images/play.svg" />');playButton.click((function(){if($("video")[0]){$("video")[0].play()}else{reportError("Play button pressed but no video there")}playButton.hide()}));$("#page").append(playButton);playButton.hide();var startPlayingVideo=function(vid_jq){if(rp.settings.shouldAutoNextSlide){clearTimeout(rp.session.nextSlideTimeoutId);vid_jq.removeAttr("loop")}vid_jq[0].muted=!rp.settings.sound;var subTracks=vid_jq[0].textTracks||[];for(var i=0;i<subTracks.length;i++){subTracks[i].mode="hidden"}var onEndFunc=function(){if(rp.settings.shouldAutoNextSlide)nextSlide()};vid_jq.one("ended",onEndFunc);var playPromise=vid_jq[0].play();if(playPromise&&playPromise.catch){playPromise.catch((function(e){if(e.name==="NotAllowedError"){playButton.show()}else{}console.log(e)}))}};var slideBackgroundPhoto=function(imageIndex){var divNode;if(rp.cache[imageIndex]===undefined){divNode=createDiv(imageIndex)}else{divNode=rp.cache[imageIndex]}divNode.prependTo(pictureSliderId);fixRedditVideo(imageIndex);$(pictureSliderId+" div").fadeIn(rp.settings.animationSpeed);var oldDiv=$(pictureSliderId+" div:not(:first)");oldDiv.fadeOut(rp.settings.animationSpeed,(function(){oldDiv.remove();rp.session.isAnimating=false;animationFinished();var maybeVid=$("video");if(maybeVid.length>0){startPlayingVideo(maybeVid)}}))};var fixRedditVideo=function(imageIndex){var photo=rp.photos[imageIndex];if(photo.url.indexOf("//v.redd.it/")<0){return}if(!photo.data.secure_media||!photo.data.secure_media.reddit_video){console.log("Some new reddit videos seem to have a null secure_media. Hmmm.");return}var url=photo.data.secure_media.reddit_video.dash_url;var player=dashjs.MediaPlayer().create();player.initialize(document.querySelector("video"),url,true)};var createDiv=function(imageIndex){var photo=rp.photos[imageIndex];var divNode=$("<div />");if(photo.type===embedit.imageTypes.image){preLoadImages(photo.url);var cssMap=Object();cssMap["display"]="none";cssMap["background-image"]="url("+photo.url+")";cssMap["background-repeat"]="no-repeat";cssMap["background-size"]="contain";cssMap["background-position"]="center";divNode.css(cssMap).addClass("clouds")}else{embedit.embed(photo.url,(function(elem){if(!elem){reportError("Failed to handle url");return divNode}if(photo.url.indexOf("//v.redd.it/")>=0){elem=$('<video autoplay playsinline loop controls="true" />')}divNode.append(elem);$(elem).attr({playsinline:""});if(photo.sound){}elem.width("100%").height("100%");if(elem[0].pause){elem[0].pause()}}))}return divNode};var skipGallery=async function(){photo=rp.photos[rp.session.activeIndex];if(!photo.data.is_gallery){return}var skipCount=photo.galleryTotal-photo.galleryItem+1;nextSlide(skipCount)};var verifyNsfwMakesSense=function(){var nsfwImages=0;for(var i=0;i<rp.photos.length;i++){if(rp.photos[i].over18){nsfwImages+=1}}if(.8<nsfwImages*1/rp.photos.length){rp.settings.nsfw=true;$("#nsfw").prop("checked",rp.settings.nsfw)}};var decodeUrl=function(url){return decodeURIComponent(url.replace(/\+/g," "))};rp.getRestOfUrl=function(){var regexS="(/(?:(?:r/)|(?:imgur/a/)|(?:u(?:ser)?/)|(?:domain/)|(?:search))[^&#?]*)[?]?(.*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.href);if(results===null){return["",""]}else{return[results[1],decodeUrl(results[2])]}};var failCleanup=function(){if(rp.photos.length>0){return}$("#navboxTitle").text("");$("#recommend").css({display:"block"})};var parseQuery=function(queryString){var query={};var pairs=(queryString[0]==="?"?queryString.substr(1):queryString).split("&");for(var i=0;i<pairs.length;i++){var pair=pairs[i].split("=");query[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]||"")}return query};var shuffle=function(arr){var i,j,x;for(i=arr.length-1;i>0;i--){j=Math.floor(Math.random()*(i+1));x=arr[i];arr[i]=arr[j];arr[j]=x}return arr};var isShuffleOn=function(){var query=parseQuery(window.location.search);return!!query.shuffle};var getRedditImages=function(){rp.session.loadingNextImages=true;var subredditUrl=rp.subredditUrl;if(rp.photos.length>0&&(subredditUrl==="/r/randnsfw"||subredditUrl==="/r/random")){subredditUrl="/r/"+rp.photos[0].subreddit}if(subredditUrl.length>0&&subredditUrl[subredditUrl.length-1]!=="/"){subredditUrl+="/"}var jsonUrl=embedit.redditBaseUrl+subredditUrl+".json?"+(rp.session.after?rp.session.after+"&":"")+getVars;var failedAjax=function(){var message="Failed ajax, maybe a bad url? Sorry about that :(";var isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(isFirefox){message="Failed ajax, Firefox try to disable tracking protection from the shield in the URL bar"}reportError(message);failCleanup()};var handleData=function(data){var childrenAndAfter=embedit.processRedditJson(data);var children=childrenAndAfter.children;var after=childrenAndAfter.after;if(children.length===0){reportError("No data from this url :(");return}if(isShuffleOn()){shuffle(children)}$.each(children,(function(i,item){if(!item||!item.data){reportError("invald data item");return}addImageSlide(item)}));verifyNsfwMakesSense();if(!rp.session.foundOneImage){reportError("Sorry, no displayable images found in that url :(")}if(rp.session.activeIndex==-1){showDefault()}if(after){rp.session.after="&after="+after}else{console.log("No more pages to load from this subreddit, reloading the start");var numberButton=$("<span />").addClass("numberButton").text("-");addNumberButton(numberButton)}rp.session.loadingNextImages=false};if(rp.settings.debug)console.log("Ajax requesting: "+jsonUrl);var useJsonP=true;if(useJsonP){jsonUrl+="&jsonp=?"}$.ajax({url:jsonUrl,dataType:useJsonP?"jsonp":"json",jsonp:useJsonP,success:handleData,error:failedAjax,404:failedAjax,timeout:5e3})};var getImgurAlbum=function(url){var albumID=url.match(/.*\/(.+?$)/)[1];var jsonUrl="https://api.imgur.com/3/album/"+albumID;var failedAjax=function(){reportError("Failed ajax, maybe a bad url? Sorry about that :(");failCleanup()};var handleData=function(data){var children=data.data.images;if(children.length===0){reportError("No data from this url :(");return}if(isShuffleOn()){shuffle(children)}$.each(children,(function(i,item){addImageSlide({url:item.link,title:item.title,over18:item.nsfw,commentsLink:""})}));verifyNsfwMakesSense();if(!rp.session.foundOneImage){console.log(jsonUrl);reportError("Sorry, no displayable images found in that url :(")}if(rp.session.activeIndex===-1){showDefault()}rp.session.loadingNextImages=false};$.ajax({url:jsonUrl,dataType:"json",success:handleData,error:failedAjax,404:failedAjax,timeout:5e3,beforeSend:function(xhr){xhr.setRequestHeader("Authorization","Client-ID "+"f2edd1ef8e66eaf")}})};var setupUrls=function(){rp.urlData=rp.getRestOfUrl();rp.subredditUrl=rp.urlData[0];getVars=rp.urlData[1];if(getVars.length>0){getVarsQuestionMark="?"+getVars}else{getVarsQuestionMark=""}rp.subredditUrl=rp.subredditUrl.replace(/.compact/,"");rp.subredditUrl=rp.subredditUrl.replace(/\/{2,}/,"/");var subredditName;if(rp.subredditUrl===""){rp.subredditUrl="/";subredditName="reddit.com"+getVarsQuestionMark}else{subredditName=rp.subredditUrl+getVarsQuestionMark}var visitSubredditUrl=embedit.redditBaseUrl+rp.subredditUrl+getVarsQuestionMark;var displayedSubredditName=subredditName;var capsize=50;if(displayedSubredditName.length>capsize){displayedSubredditName=displayedSubredditName.substr(0,capsize)+"&hellip;"}$("#subredditUrl").html("<a href='"+visitSubredditUrl+"'>sub</a>");document.title="redditP - "+displayedSubredditName};var getVars;var getVarsQuestionMark;initState();rp.loadBlockedUsers();setupUrls();rp.session.foundOneImage=false;if(rp.subredditUrl.indexOf("/imgur")===0){getImgurAlbum(rp.subredditUrl)}else{getRedditImages()}}));function browserNodeExport(exported,name){if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=exported}else{if(typeof define==="function"&&define.amd){define([],(function(){return exported}))}else{window[name]=exported}}}browserNodeExport(rp,"rp");